<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>沟通</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
	<link rel="stylesheet" href="css/sm.css">
	<link rel="stylesheet" href="css/sm-extend.css">
	<link rel="stylesheet" href="css/login.css">
	<link rel="stylesheet" href="js/layer/need/layer.css" />
	<link rel="stylesheet" href="css/wxzf.css">
	<script type="text/javascript" src="js/jquery.1.11.js" ></script>
	<script>$.noConflict();</script>
	<script type="text/javascript" src="js/mui.min.js" ></script>
	<script type="text/javascript">
	
		
//		jQuery.fn.extend({
//			slideRightShow: function() {
//			    return this.each(function() {
//			        $(this).show('slide', {direction: 'right'}, 300);
//			    });
//			},
//			slideLeftHide: function() {
//			    return this.each(function() {
//			      $(this).hide('slide', {direction: 'left'}, 300);
//			    });
//			},
//			slideRightHide: function() {
//			    return this.each(function() {
//			      $(this).hide('slide', {direction: 'right'}, 300);
//			    });
//			},
//			slideLeftShow: function() {
//			    return this.each(function() {
//			      $(this).show('slide', {direction: 'left'}, 300);
//			    });
//			}
//		});
		
		
	    jQuery.fn.slideLeftHide = function( speed, callback ) {  
	        this.animate({  
	            width : "hide",  
	            paddingLeft : "hide",  
	            paddingRight : "hide",  
	            marginLeft : "hide",  
	            marginRight : "hide"  
	        }, speed, callback );  
	    };  
	    jQuery.fn.slideLeftShow = function( speed, callback ) {  
	        this.animate({  
	            width : "show",  
	            paddingLeft : "show",  
	            paddingRight : "show",  
	            marginLeft : "show",  
	            marginRight : "show"  
	        }, speed, callback );  
	    };
	    
	</script>
	<script type='text/javascript' src='js/zepto.js' charset='utf-8'></script>
    <script type="text/javascript" src="js/update.js" ></script>    
    <script type="text/javascript" src="js/cache.js?v=1.54" ></script>
    <script type="text/javascript" src="js/socket.js" ></script>
    <script type='text/javascript' src="http://api.map.baidu.com/api?v=2.0&ak=C8Pn598qtNvbvOFXuLhN8z2j" ></script>
	<style>
		footer {
			position: fixed;
			width: 100%;
			height: 4.666666rem;
			min-height: 4.666666rem;
			border-top: solid 1px #bbb;
			left: 0px;
			bottom: 0px;
			overflow: hidden;
			
			background-color: #fafafa;
		}
		.footer-left {
			display: inline-block;
			width: 2.666666rem;
			height: 2.666666rem;			
			text-align: center;			
			line-height: 100%;
		}
		.footer-left img{
			width:2.666666rem;
			height:2.666666rem;			
		}		
		.footer-right img{
			width:2.666666rem;
			height:2.666666rem;			
		}
		
		.footer-center {
			width:17.416666rem;			
			padding: 0.833333rem 0px;
			display: inline-block;
			margin-left: 0.666666rem;
			
		}
		.footer-center [class*=input] {
			width: 100%;
			height: 100%;
			border-radius: 5px;
		}
		.footer-center .input-text {
			height:3rem;
			background: #fff;
			border: solid 1px #ddd;			
			font-size: 1.333333rem !important;
			line-height: 3rem !important;
			font-family: verdana !important;
			overflow: hidden;
		}
		.footer-center .input-sound {
			background-color: #eee;
		}
		.mui-content {
			height: 100%;
			padding: 5.666666rem 0px 4.666666rem 0px;
			overflow: auto;
			background-color: #E5E5E5;
			position: relative;
		}
		#msg-list {
			height: 100%;
			overflow: auto;
			-webkit-overflow-scrolling: touch;
		}
		.msg-item {
			padding: 8px;
			clear: both;
			position: relative;
		}
		.msg-item .mui-item-clear {
			clear: both;
		}
		.msg-item .msg-user {
			width: 3.333333rem;
			height: 3.333333rem;			
			display: inline-block;			
			border-radius: 3px;
			vertical-align: top;
			text-align: center;
			float: left;
			padding: 3px;
			color: #ddd;
		}
		
		.msg-item .msg-user-img{
			width: 2.666666rem;
			height: 2.666666rem;
			display: inline-block;
			border-radius: 3px;
			vertical-align: top;
			text-align: center;
			float: left;
			color: #ddd;
		}
		
		.msg-item .msg-content {
			display: inline-block;
			border-radius: 5px;
			border: solid 1px #d3d3d3;
			background-color: #FFFFFF;
			color: #333;
			padding: 1rem;
			vertical-align: top;
			font-size: 1.333333rem;
			position: relative;
			margin: 0px 0.666666rem;
			max-width: 75%;
			min-width: 3.333333rem;
			float: left;
			border-radius: 0px 0.83333333rem 0.83333333rem 0.83333333rem;
		}
		.msg-item .msg-content .msg-content-inner {
			overflow-x: hidden;
		}
		.msg-item .msg-content .msg-content-arrow {
			position: absolute;
			border: solid 1px #d3d3d3;
			border-right: none;
			border-top: none;
			background-color: #FFFFFF;
			width: 10px;
			height: 10px;
			left: -5px;
			top: 12px;
			-webkit-transform: rotateZ(45deg);
			transform: rotateZ(45deg);
		}
		.msg-item-self .msg-user,
		.msg-item-self .msg-content {
			float: right;
		}
		.msg-item-self .msg-content .msg-content-arrow {
			left: auto;
			right: -5px;
			-webkit-transform: rotateZ(225deg);
			transform: rotateZ(225deg);
		}
		.msg-item-self .msg-content,
		.msg-item-self .msg-content .msg-content-arrow {
			background-color: #53CF5C;
		    color: #262626;
		    border-color: #53CF5C;
		    border-radius: 0.83333333rem 0px 0.83333333rem 0.83333333rem;
		    margin-top:0;
		}
		footer .mui-icon {
			color: #000;
		}
		footer .mui-icon:active {
			color: #007AFF !important;
		}
		footer .mui-icon-paperplane:before {
			content: "发送";
		}
		footer .mui-icon-paperplane {
			/*-webkit-transform: rotateZ(45deg);
			transform: rotateZ(45deg);*/
			
			font-size: 16px;
			word-break: keep-all;
			line-height: 100%;
			padding-top: 6px;
			color: rgba(0, 135, 250, 1);
		}
		#msg-sound {
			-webkit-user-select: none !important;
			user-select: none !important;
			height:2.666666rem;
			width:100%;
			background: transparent;
		    border: 1px solid #eee;
		    border-radius: 0.25rem;
		}
		.rprogress {
			position: absolute;
			left: 50%;
			top: 50%;
			width: 140px;
			height: 140px;
			margin-left: -70px;
			margin-top: -70px;
			background-image: url(../images/arecord.png);
			background-repeat: no-repeat;
			background-position: center center;
			background-size: 30px 30px;
			background-color: rgba(0, 0, 0, 0.7);
			border-radius: 5px;
			display: none;
			-webkit-transition: .15s;
		}
		.rschedule {
			background-color: rgba(0, 0, 0, 0);
			border: 5px solid rgba(0, 183, 229, 0.9);
			opacity: .9;
			border-left: 5px solid rgba(0, 0, 0, 0);
			border-right: 5px solid rgba(0, 0, 0, 0);
			border-radius: 50px;
			box-shadow: 0 0 15px #2187e7;
			width: 46px;
			height: 46px;
			position: absolute;
			left: 50%;
			top: 50%;
			margin-left: -23px;
			margin-top: -23px;
			-webkit-animation: spin 1s infinite linear;
			animation: spin 1s infinite linear;
		}
		.r-sigh{
			display: none;
			border-radius: 50px;
			box-shadow: 0 0 15px #2187e7;
			width: 46px;
			height: 46px;
			position: absolute;
			left: 50%;
			top: 50%;
			margin-left: -23px;
			margin-top: -23px;
			text-align: center;
			line-height: 46px;
			font-size: 40px;
			font-weight: bold;
			color: #2187e7;
		}
		.rprogress-sigh{
			background-image: none !important;
		}
		.rprogress-sigh .rschedule{
			display: none !important;
		}
		.rprogress-sigh .r-sigh{
			display: block !important;
		}
		.rsalert {
			font-size: 12px;
			color: #bbb;
			text-align: center;
			position: absolute;
			border-radius: 5px;
			width: 130px;
			margin: 5px 5px;
			padding: 5px;
			left: 0px;
			bottom: 0px;
		}
		@-webkit-keyframes spin {
			0% {
				-webkit-transform: rotate(0deg);
			}
			100% {
				-webkit-transform: rotate(360deg);
			}
		}
		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}
		#h {
			background: #fff;
			border: solid 1px #ddd;
			padding: 10px !important;
			font-size: 16px !important;
			font-family: verdana !important;
			line-height: 18px !important;
			overflow: visible;
			position: absolute;
			left: -1000px;
			right: 0px;
			word-break: break-all;
			word-wrap: break-word;
		}
		.cancel {
			background-color: darkred;
		}
		.inner-line{padding:0.66666666rem 0;}
		.inner-block{padding:0 1.33333333rem;}
		.btn-big-disable {
		    border-radius: 2px;
		    color: #737373;
		    background-color: #5f5f5f;
		    border: 1px solid #ddd;
		}
		.chat-content{
			padding-bottom:4rem;
		}
		.msg-item .msg-promise{
			background-color: transparent;
			border:0;
			padding:0;
		}
		.user-name{
			display: inline-block;
    		padding: 0.1rem 1rem;
    		font-size:1rem;
    		color:#969696;
    		display:none;
		}
		#msg-scroll{
			position: absolute;
			top:4rem;
			bottom: 0rem;
			width:100%;
			height:80%;
		}
	</style>
	
</head>
<body>
    <div class="page-group" style="background-color:#f5f5f5;" id="chat-index">
    	<!--打开红包页面-->
    	<div class="page" id='zd-chat-chai' style="background-color:#f5f5f5;">        	
			<header class="bar bar-nav mynav">				
				<a class="button pull-left btn-back myback"><img src="images/icon/icon-arrow-left.png" class="icon-close" /></a>				
        		<h1 class="title">红包详情</h1>
			</header>
			
        	<div class="content chat-content" style="position: relative;height:100%;">
        		<div class="numb_box" id="get_hongbao" style="display: block;background-color:#fff;z-index:9999;height:100%;top:0;">
					<div class="hongbao-page">
						<div class="hongbao-page-top">
							<span class="hongbao-page-close">+</span>
							<span class="hongbao-page-title">红包详情</span>	
						</div>
						<div class="hongbao-page-top-bg" style="" ></div>
						<div id="hongbao-page-info">
							<div class="hongbao-page-face">
								<p class="hongbao-page-face-img" style="">
									<img id="hb_user_pic" src="images/pay-eqcode.png" style="" />
								</p>
								<p id="hb_nickname">Key Mini</p>
								<p id="hb_money">￥222.22</p>
								<p>已存入余额，可直接提现</p>
								<div id="hongbao_log">
									<div class="inner-line inner-bottom-line">已抢红包 10/25 个</div>
									<div class="inner-line hongbao-log-item" style="display:table;">
										<span><img src="images/chat1.png"  /></span>
										<span class="inner-bottom-line">
											<span class="hongbao-log-userinfo">
												<p>MUCU设计</p>
												<p>11:24:11</p>
											</span>
											<span class="hongbao-log-money">￥50.55</span>
										</span>
									</div>
								</div>
							</div>				
							
						</div>			
					</div>		
				</div>
			</div>
        </div>
    	<!--发送红包页面-->
    	<div class="page" id='zd-chat-hongbao' style="background-color:#f5f5f5;">        	
			<header class="bar bar-nav mynav">				
				<a class="button pull-left btn-back hongbao-back"><img src="images/icon/icon-arrow-left.png" class="icon-close" /></a>				
        		<h1 class="title">红包</h1>
			</header>
			
        	<div class="content chat-content" style="position: relative;height:100%;padding:1.33333333rem">
        		<div class="inner-block">
        			<div class="inner-line">
	        			<span style="display: table-cell;">红包金额</span>
	        			<span style="display: table-cell;"><input type="number" id="hongbao_money" placeholder="0.00"/> 元</span>
	        		</div>	
        		</div>
        		<br />
        		<div class="inner-block" id="group_hongbao" style="display:block;">
        			<div class="inner-line">
	        			<span style="display: table-cell;">红包数量</span>
	        			<span style="display: table-cell;"><input type="number" id="hongbao_num" placeholder="填写数量"/> 个</span>
	        		</div>
        		</div>
        		<p style="font-size: 4rem;text-align: center;margin: 1rem 0;">￥<span id="hongbao_total">0.00</span></p>
        		<button class="btn-big " id="hongbao_pay_btn" style="background-color:#EB454B;color:#FFD783;">塞进红包</button>
			</div>
        </div>
    	<!--诚信金子页面-->
    	<div class="page" id='zd-chat-promise' style="background-color:#f5f5f5;">
			<header class="bar bar-nav mynav">				
				<a class="button pull-left btn-back back"><img src="images/icon/icon-arrow-left.png" class="icon-close" /></a>				
        		<h1 class="title">诚信金</h1>
			</header>
			
        	<div class="content chat-content" style="position: relative;height:100%;">
        		<div class="inner-block">
        			<div class="inner-line">
        				<div class="inner-label">金额</div>
        				<div class="inner-content"><input type="number" placeholder="输入约定的诚信金额" id="promise_money"/></div>
        			</div>
        		</div>
        		<p style="padding:0 1.33333333rem;">约定条件（非必填项）</p>
        		<div class="inner-block">
        			<div class="inner-line inner-bottom-line">
        				<div class="inner-label">约定位置</div>
        				<div class="inner-content">
        					<span class="inner-text" id="promise_position" style="width:17.2056151rem;"></span>
        					<a href="#zd-chat-position"><i class="icon icon-map pull-right"></i></a>
        				</div>
        			</div>
        			<div class="inner-line inner-bottom-line">
        				<div class="inner-label">约定时间</div>
        				<div class="inner-content">
        					<div class="inner-top inner-bottom-line">从<input type="text" placeholder="约定开始时间" id="start_time" /></div>
        					<div class="inner-bottom inner-bottom-line">至<input type="text" placeholder="约定截止时间" id="end_time" /></div>
        				</div>
        			</div>
        			<div class="inner-line inner-bottom-line">
        				<div class="inner-label">浮动范围</div>
        				<div class="inner-content">
        					<div class="inner-text">
        						<input type="text" placeholder="可浮动时间范围" id="float_time"/>
        					</div>
        				</div>
        			</div>
        			<div class="inner-line inner-bottom-line">
        				<div class="inner-label">备注</div>
        				<div class="inner-content">
        					<div class="inner-text">
        						<textarea id="note" placeholder="输入所需的备注"></textarea>
        					</div>
        				</div>
        			</div>
        			<div class="inner-line inner-bottom-line">
        				<div class="inner-label">最晚取消时间</div>
        				<div class="inner-content">
        					<div class="inner-text">
        						<input type="text" placeholder="最迟取消约定时间" id="last_time"  />
        					</div>
        				</div>
        			</div>
        		</div>
        		<p style="padding:0 1.33333333rem;">在最晚时间之前取消，可以免扣诚信金</p>
        		<p style="padding:0 1.33333333rem;"><button class="btn-big " id="promise_pay_btn">确定并支付</button></p>
			</div>
			
			<script>
				$(function(){
					var can_submit = 0;
					$("#start_time").datetimePicker({});					
					$("#end_time").datetimePicker({});
					$("#last_time").datetimePicker({});
					$("#float_time").picker({
						toolbarTemplate: '<header class="bar bar-nav">\
						<button class="button button-link pull-right close-picker">确定</button>\
  						<h1 class="title">请选择时间</h1>\
						</header>',
						cols: [
							{
						      textAlign: 'center',
						      values: ['1小时','2小时','3小时','4小时','5小时','6小时','7小时','8小时','9小时','10小时','11小时','12小时','13小时','14小时','15小时','16小时','17小时','18小时','19小时','20小时','21小时','22小时','23小时','24小时']
						    },
							{
						      textAlign: 'center',
						      values: ['1分钟','2分钟','3分钟','4分钟','5分钟','6分钟','7分钟','8分钟','9分钟','10分钟','11分钟','12分钟','13分钟','14分钟','15分钟','16分钟','17分钟','18分钟','19分钟','20分钟','21分钟','22分钟','23分钟','24分钟','25分钟','26分钟','27分钟','28分钟','29分钟','30分钟','31分钟','32分钟','33分钟','34分钟','35分钟','36分钟','37分钟','38分钟','39分钟','40分钟','41分钟','42分钟','43分钟','44分钟','45分钟','46分钟','47分钟','48分钟','49分钟','50分钟','51分钟','52分钟','53分钟','54分钟','55分钟','56分钟','57分钟','58分钟','59分钟']
						    }
						]
					});
					$("#promise_money").on('keyup',function(){
						value = $(this).val();
						if(value == ''){
							$("#promise_pay_btn").addClass('btn-big-disable');
							can_submit = 0;
						}else{
							$("#promise_pay_btn").removeClass('btn-big-disable');
							can_submit = 1;
						}
					})					
				})
			</script>
        </div>
        <!--位置选择子页面-->
    	<div class="page" id='zd-chat-position' style="background-color:#f5f5f5;">        	
			<header class="bar bar-nav mynav">				
				<a class="button pull-left btn-back back"><img src="images/icon/icon-arrow-left.png" class="icon-close" /></a>
				<a class="button pull-right btn-back span-btn" style="background-color: #53CE5A;color: #fff;" id="position_send">发送</a>
        		<h1 class="title">位置</h1>
			</header>
			
        	<div class="content chat-content" style="position: relative;height:100%;">
        		<div id="bmap" style="height:26rem;"></div>
        		<div class="drop-menu drop-menu-bottom" style="padding-bottom:4rem;background-color:#fff;max-height: none;overflow-y: scroll;height:27rem;">
				  	<ul id="poisList"></ul>
				</div>
			</div>			
        </div>
    	
    	
        <div class="page page-current" id='group-chat' style="background-color:#f5f5f5;">
        	<header class="bar bar-nav">
        		<button class="button pull-left btn-back mybackbtn"><img src="images/icon/icon-arrow-left.png" class="icon-close" /></button>
				<button class="button pull-right btn-back" style="top:0;height:4rem;">
					<!--<img src="images/icon/icon-chat-shop.png" id="icon-shop" class="icon-close" data-url="index-shop-index.html"/>-->
					<img src="images/icon/icon-chat-group.png" class="icon-close" data-url="chat-group-detail.html" style="width:4rem;"/>
				</button>
        		<h1 class="title" id="title"></h1>
			</header>
        	<div class="content chat-content"></div>
			<div class="mui-content" style="position:relative;padding-bottom:6rem;">
				<div id="msg-scroll">
					<div id="scroller">	
				<div id='msg-list'>
					<!--<div id="{{item.mid}}" class="msg-item " msg-type='{{item.type}}' msg-content='{{item.content}}' msg-show_path='{{item.show_path}}'>
					<img class="msg-user" src="images/chat2.png" />
					<div class="user-name" style="display:block;padding: 0.3rem 1rem;padding-left:4rem;font-size:1rem;color:#969696;text-align: left;;">发到空间</div>
					<div class="msg-content">
						<div class="msg-content-inner">
							发牢骚的会计
						</div>						
					</div>			
					<div class="mui-item-clear"></div>-->
				</div>
					</div>
				</div>
				
			</div>
			
			
			
			<script id='msg-template' type="text/html">
				{{each record as item i}}
				{{if item.type == 'notice'}}
				<div class="msg-notice">
					<span>{{item.content}}</span>
				</div>
				{{else}}
				<div id="{{item.mid}}" class="msg-item {{if item.sender == 'self'}}msg-item-self{{/if}} " msg-type='{{item.type}}' msg-content='{{item.content}}' msg-show_path='{{item.show_path}}' {{if item.type == 'hongbao'}} msg-objid="{{item.objid}}" {{/if}}>					
					{{if(item.sender=='self' )}}
						<img class="msg-user mui-icon mui-icon-person" src="{{if item.logo_src == ''}}images/chat1.png{{else}}{{item.logo_src}}{{/if}}" />
					{{else}}
						<img class="msg-user" src="{{if item.logo_src == ''}}images/chat2.png{{else}}{{item.logo_src}}{{/if}}" />
					{{/if}}
					{{if item.sender == 'self'}}{{else}}
					<div class="user-name" style="display:block;padding: 0.3rem 1rem;padding-left:4rem;font-size:1rem;color:#969696;text-align: left;;">
						{{item.nickname}}
						{{if private_room_id == ''}}
						<span class="pull-right private-tag" data-userid="{{item.user}}" style="background-color:#959595;color:#e2e2e2;display: inline-block;padding:0 0.5rem;border-radius: 4rem;line-height:1.6666666rem;">私聊</span>
						{{/if}}
					</div>
					{{/if}}
					<div class="msg-content" {{if item.type != 'text' && item.type != 'sound'}}style="background-color:#fff;padding:0;border:0;{{if item.type == 'hongbao'}}width:18rem;{{else}}width:100%;{{/if}}"{{/if}}>
						<div class="msg-content-inner">
							{{if item.type=='text' }}
								{{item.content}}
							{{/if}}
							{{if item.type == 'image' }}
								<img class="msg-content-image" src="{{item.content}}" style="max-width: 20rem;" />
							{{/if}}
							{{if item.type == 'position' }}
								<img class="msg-content-image" src="{{item.show_path}}" style="max-width: 20rem;" />
							{{/if}}
							{{ if item.type=='sound' }}
								<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>
								<span class="play-state">点击播放</span>
							{{/if}}
							{{ if item.type=='video' }}
								<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>
								<span class="play-state">点击播放</span>
							{{/if}}
							{{if item.type == 'face' }}
								<img class="msg-content-image" src="{{item.content}}" style="max-width: 100px;" />
							{{/if}}
							{{if item.type == 'hongbao'}}
								<div class="inner-line" style="display:table;background-color:#FA9E3B;height:4rem;width:100%;">
									<span style="display:table-cell;vertical-align: middle;text-align:center">
										<img src="images/icon/icon-chat-hongbao.png" style="width:3rem;vertical-align: middle;"/>
									</span>
									<span style="display:table-cell;vertical-align: middle;text-align:center;color:#fff;font-size:1.3333333rem;padding-left: 0.5rem;">
										{{if item.title == ''}}恭喜发财，大吉大利{{else}}{{item.title}}{{/if}}
									</span>
								</div>
								<div style="padding-left:0.66666666rem;height:1.5rem;background-color:#fff;line-height:1.5rem;font-size:0.8rem;color:#959595">诚信红包</div>
							{{/if}}
							{{if item.type == 'share'}}
								<div class="inner-line share-item table" style="background-color:#fff;height:2rem;width:20rem;color:#262626;">									
									<div style="display:table-cell;vertical-align: middle;text-align:center;width:3rem;padding-left:1rem;">
										<div class="img-div" style="background-image:url({{item.share_data.thumb}})"></div>										
									</div>
									<div style="display:table-cell;vertical-align: middle;text-align:left;color:#959595;font-size:1rem;padding-left: 0.5rem;">
										<p style="margin-bottom:0.66666666rem;font-size:1.33333333rem;width:100%;color:#262626;">{{item.share_data.title}}</p>
										<p style="margin:0;font-size:1rem;color:#959595;width:100%;">{{item.share_data.desc}}</p>
									</div>								
								</div>														
							{{/if}}
							{{if item.type == 'promise'}}
								<div class="msg-content-promise">
									<div class="msg-content-promise-head">
										<span><img src="images/chat-promise-msg.png" /></span>
										<span>
											￥{{msg.promise_data.price}}<br />诚信金
										</span>
									</div>
									<div class="msg-content-promise-body">
										<div class="inner-line">
											<div class="inner-label">约定位置</div>
											<div class="inner-content">{{msg.promise_data.addr}}</div>
										</div>
										<div class="inner-line">
											<div class="inner-label">约定时间</div>
											<div class="inner-content">
												<div class="inner-top">从 {{msg.promise_data.start}}</div>
    											<div class="inner-bottom">至 {{msg.promise_data.end}}</div>
											</div>
										</div>
										<div class="inner-line">
											<div class="inner-label">备注</div>
											<div class="inner-content">{{msg.promise_data.note}}</div>
										</div>
										<div class="inner-line">
											<div class="inner-label">违约时间</div>
											<div class="inner-content">{{msg.promise_data.last}}</div>
										</div>
									</div>
									<div class="msg-content-promise-foot">
										<span class="promise-tousu">投诉</span>
										<span class="promise-complate">完成</span>
										<span class="promise-cancel">取消</span>
									</div>									
								</div>
							{{/if}}
						</div>						
					</div>					
					<div class="mui-item-clear"></div>
				</div>
				{{/if}}
				{{/each}}				
			</script>	
			<footer class="">
				<div class="tool">
					<ul>
						<li class="footer-left">
							<img id="chat-type" src="images/icon/icon-chat-sound.png" />							
						</li>
						<li>
							<textarea id="msg-content" class="info-textarea chat-text" placeholder=""></textarea>
							<button id='msg-sound' type="button" class='input-sound' style="display: none;margin-top: 0.6666666666rem;margin-bottom: 1.333333333rem;">按住说话</button>
						</li>
						<li class="footer-right">
							<img id="msg-face" src="images/icon/icon-chat-face.png" />
							<img id="msg-more" src="images/icon/icon-chat-more.png" />
						</li>
						<div class="clearfix"></div>
					</ul>
				</div>
				<div class="footer-more">
					<ul>
						<li>
							<a href="javascript:;" id="zd-chat-promise-btn" onclick="close_foot();">
								<img id="choose-promise" src="images/chat-promise.png" />
								<p>诚信金</p>
							</a>
						</li>
						<li>
							<a href="#zd-chat-position" data-no-cache="true" id="zd-chat-position-btn">
								<img id="choose-position" src="images/chat-position.png" />
								<p>位置</p>
							</a>
						</li>
						<li>
							<a href="javascript:;" id="uc-pay.html" onclick="close_foot();clicked(this.id)">
								<img id="choose-pay" src="images/chat-pay.png" />
								<p>收付款</p>
							</a>
						</li>						
						<li>
							<a href="#zd-chat-hongbao" onclick="close_foot();">
								<img id="choose-hongbao" src="images/chat-hongbao.png" />
								<p>红包</p>
							</a>
						</li>
						
						<li>
							<img id="choose-pic" src="images/icon/icon-chat-picture.png" />
							<p>图片</p>
						</li>
						<li>
							<img id="choose-photo" src="images/icon/icon-chat-photo.png" />
							<p>拍照</p>
						</li>
						<li>
							<img id="choose-video" src="images/icon/icon-chat-video.png" />
							<p>视频</p>
						</li>
						<li>
							<img id="choose-card" src="images/chat-card.png" />
							<p>名片</p>
						</li>
						<div class="clearfix"></div>
					</ul>
				</div>
			</footer>
			<div id='sound-alert' class="rprogress">
				<div class="rschedule"></div>
				<div class="r-sigh">!</div>
				<div id="audio_tips" class="rsalert">手指上滑，取消发送</div>
			</div>			
			<script>
        	$(function(){        		
        		$("#zd-chat-promise-btn").click(function(){
        			$.myUtil().toast('群聊不能使用');
        			close_foot();
        			//$.router.load("#zd-chat-promise");
        			//is_promist_page = 1;
        		})
        		$("#zd-chat-position-btn").click(function(){
        			close_foot();
        			is_promist_page = 0;
        		});
        	})
        	</script>
        </div>        
    </div>
    
    <div class="backdrop"></div>
    <div class="numb_box" id="promise_pay_form" style="display: none;background-color:#fff;z-index:9999;">
		<p style="height:4rem;display: table;width:100%;">
			<span style="display:table-cell;vertical-align: middle;width:11rem;text-align:left;padding-left:1rem;" id="pay_close"><span class="span-btn">关闭</span></span>
			<span style="display:table-cell;vertical-align: middle;text-align:left;font-size:1.33333333333rem;color:#262626;">输入支付密码</span>
		</p>
		<p style="padding:0 1.333333rem">
			<!--<input type="password" readonly="" id="pay-money" placeholder="输入6位支付密码" class="pay-password">-->
			<ul class="mm_box">
		      	<li class=""></li>
		      	<li class=""></li>
		      	<li class=""></li>
		      	<li class=""></li>
		      	<li class=""></li>
		      	<li></li>
		    </ul>
		</p>
		
		
	    <!--<div class="xiaq_tb"><img src="images/jftc_14.jpg" height="10"></div>-->
	    <ul class="nub_ggg">
	    	<li><a href="javascript:void(0);">1</a></li>
	      	<li><a href="javascript:void(0);" class="zj_x">2</a></li>
	      	<li><a href="javascript:void(0);">3</a></li>
	      	<li><a href="javascript:void(0);">4</a></li>
	      	<li><a href="javascript:void(0);" class="zj_x">5</a></li>
	      	<li><a href="javascript:void(0);">6</a></li>
	      	<li><a href="javascript:void(0);">7</a></li>
	      	<li><a href="javascript:void(0);" class="zj_x">8</a></li>
	      	<li><a href="javascript:void(0);">9</a></li>
	      	<li><span></span></li>
	      	<li><a href="javascript:void(0);" class="zj_x">0</a></li>
	      	<li><span class="del"> <img src="images/pay-confirm-back.png"></span></li>
	    </ul>
	</div>
	
	<!--<div class="numb_box" id="get_hongbao" style="display: none;background-color:#fff;z-index:9999;height:100%;top:0;">
		<div class="hongbao-page">
			<div class="hongbao-page-top">
				<span class="hongbao-page-close">+</span>
				<span class="hongbao-page-title">红包详情</span>	
			</div>
			<div class="hongbao-page-top-bg" style="" ></div>
			<div id="hongbao-page-info">
				<div class="hongbao-page-face">
					<p class="hongbao-page-face-img" style="">
						<img id="hb_user_pic" src="images/pay-eqcode.png" style="" />
					</p>
					<p id="hb_nickname">Key Mini</p>
					<p id="hb_money">￥222.22</p>
					<p>已存入余额，可直接提现</p>
					<div id="hongbao_log">
						<div class="inner-line inner-bottom-line">已抢红包 10/25 个</div>
						<div class="inner-line hongbao-log-item" style="display:table;">
							<span><img src="images/chat1.png"  /></span>
							<span class="inner-bottom-line">
								<span class="hongbao-log-userinfo">
									<p>MUCU设计</p>
									<p>11:24:11</p>
								</span>
								<span class="hongbao-log-money">￥50.55</span>
							</span>
						</div>
					</div>
				</div>				
				
			</div>			
		</div>		
	</div>-->
    
    <script id='hongbao_logT' type="text/html">
    	<div class="inner-line inner-bottom-line">已抢红包 {{not_received_num}}/{{pnum}} 个</div>
    		{{each list as item i}}
			<div class="inner-line hongbao-log-item" style="display:table;">
				<span><img src="{{item.user_logo}}"  /></span>
				<span class="inner-bottom-line">
					<span class="hongbao-log-userinfo">
						<p>{{item.nickname}}</p>
						<p>{{item.receive_time}}</p>
					</span>
					<span class="hongbao-log-money">￥{{item.receive_money}}</span>
				</span>
			</div>
			{{/each}}
    </script>
    
    
    <div class="dialog-container" id="promist_show">
		<div class="promise-dialog">
			<div class="promise-dialog-head">
				<p>136****5678 承诺诚信金 </p>
				<p>￥9999.9 元</p>
				<p>您是否同意出具同样金额的诚信金作为违约赔偿</p>
			</div>
			<div class="promise-dialog-body">
				<div class="inner-line">
					<div class="inner-label">约定位置</div>
					<div class="inner-content">南阳建西路口</div>						
				</div>
				<div class="inner-line">
					<div class="inner-label">约定时间</div>
					<div class="inner-content">
    					<div class="inner-top">从 2017-05-27 12:22</div>
    					<div class="inner-bottom">至 2017-05-28 09:12</div>
    				</div>
				</div>
				<div class="inner-line">
					<div class="inner-label">备注</div>
					<div class="inner-content">发牢骚的空间疯狂就冻死了分开多久</div>						
				</div>
				<div class="inner-line">
					<div class="inner-label">违约时间</div>
					<div class="inner-content">2017-05-28 12:00</div>						
				</div>
			</div>
			<div class="promise-dialog-foot">
				<span id="promise_dialog_failed">拒绝</span>
				<span id="promise_dialog_agree">同意</span>
			</div>
		</div>
	</div>
	
	<script id='promiseT' type="text/html">
		<div class="promise-dialog">
			<div class="promise-dialog">
			<div class="promise-dialog-head">
				<p>{{item.user_id}} 承诺诚信金 </p>
				<p>￥{{item.price}} 元</p>
				<p>您是否同意出具同样金额的诚信金作为违约赔偿</p>
			</div>
			<div class="promise-dialog-body">
				<div class="inner-line">
					<div class="inner-label">约定位置</div>
					<div class="inner-content">{{item.local}}</div>						
				</div>
				<div class="inner-line">
					<div class="inner-label">约定时间</div>
					<div class="inner-content">
    					<div class="inner-top">从 {{item.start}}</div>
    					<div class="inner-bottom">至 {{item.end}}</div>
    				</div>
				</div>
				<div class="inner-line">
					<div class="inner-label">备注</div>
					<div class="inner-content">{{item.note}}</div>						
				</div>
				<div class="inner-line">
					<div class="inner-label">违约时间</div>
					<div class="inner-content">{{item.last}}</div>						
				</div>
			</div>
			<div class="promise-dialog-foot">
				<span id="promise_dialog_failed">拒绝</span>
				<span id="promise_dialog_agree">同意</span>
			</div>
		</div>
		</div>
	</script>    
  
	
	<script id='poisListT' type="text/html">				
		{{each list as item i}}
		<li class="position inner-bottom-line" data-type="0" data-lng="{{item.point.x}}" data-lat="{{item.point.y}}" data-name="{{item.name}}" data-addr="{{item.addr}}" style="height: inherit;">
			<span style="width:100%;display:block;">{{item.name}}</span>
			<p style="margin:0.66666666rem 0;color:#959595;font-size:1rem;width:80%;display: inline-block;">{{item.addr}}</p>
			<i class="pull-right icon icon-cb-uncheck"></i>				
		</li>
		{{/each}}
	</script>


<script>
	var hongbao_is_open = false;
	var cxj_is_open = false;
	var position_is_open = false;	
	var chai_is_open = false;
(function(w){
// 空函数
function shield(){
	return false;
}
document.addEventListener('touchstart',shield,false);//取消浏览器的所有事件，使得active的样式在手机上正常生效
document.oncontextmenu=shield;//屏蔽选择函数
// H5 plus事件处理
var ws=null,as='pop-out';
function plusReady(){
	
	ws=plus.webview.currentWebview();
	// Android处理返回键
	plus.key.addEventListener('backbutton',function(){		
		now_ww = plus.webview.currentWebview();		
		if(cxj_is_open || position_is_open){
			$.router.back();
			cxj_is_open = false;
			position_is_open = false;				
			return;
		}		
		if(hongbao_is_open){		
			$.router.back();
			hongbao_is_open = false;
			return;
		}		
		if(chai_is_open){			
			$("#get_hongbao").hide();		
			chai_is_open = false;		
			return;
		}			
//		hongbao_div = $("#get_hongbao").css('display');		
//		if($("#get_hongbao").css('display') == 'block'){			
//			$("#get_hongbao").hide();		
//			return;
//		}
		xinPage = plus.webview.getWebviewById('xin-index.html');
		if(xinPage){
			socket.disconnect();
			xinPage.evalJS('refreshPage()');
		}
	},false);
	compatibleAdjust();
}
if(w.plus){
	plusReady();
}else{
	document.addEventListener('plusready',plusReady,false);
}
// DOMContentLoaded事件处理
var domready=false;
document.addEventListener('DOMContentLoaded',function(){
	domready=true;
	gInit();
	document.body.onselectstart=shield;
	compatibleAdjust();
},false);

w.qrcode_config = {};

// 处理返回事件
w.back=function(hide){
//	taskList = plus.webview.getWebviewById("uc-usetting.html");
//	taskList.reload();
	
    now_ww = plus.webview.currentWebview();
    chat_index_page = plus.webview.getWebviewById('xin-index.html');
    id = now_ww.id;    
    if(chat_index_page != null){
    	if( id.indexOf("chat-group-normal-chat.html")>=0 || id.indexOf("chat-chat.html")>=0 || id.indexOf("chat-group-chat.html")>=0 || id.indexOf("index-xunjia-chat.html")>=0 || id.indexOf("zd-chat.html")>=0 ){	
			var qs=id.lastIndexOf("=")+1; 
			//同时清除未读消息数量
			cid = plus.webview.getWebviewById('index-all.html');
			console.error("  $('#wd"+id.substr(qs,99) +"').html('0').hide(); ");
			cid.evalJS("  $('#wd"+id.substr(qs,99) +"').html('0').hide(); ");
			socket.disconnect();
			history.back();
		}
    }    
    if(now_ww.id == 'index-xunjia.html'){
    	clicked('index-all.html');
    }
    
    
	if(w.plus){
		ws||(ws=plus.webview.currentWebview());
		if(hide||ws.preate){	
			ws.hide('auto');
		}else{
			
			if(ws.id == 'newdrag'){
				nw = plus.webview.getWebviewById('index-map.html');			
				nw.close('auto');
			}
			ws.hide('auto');
		}
	}else if(history.length>1){
		history.back();
	}else{
		w.close();
	}
};
// 处理点击事件
var openw=null,waiting=null;
/**
 * 打开新窗口
 * @param {URIString} id : 要打开页面url
 * @param {boolean} wa : 是否显示等待框
 * @param {boolean} ns : 是否不自动显示
 * @param {JSON} ws : Webview窗口属性
 */
w.clicked=function(id,wa,ns,ws,myas){
	
	if( id.indexOf("ull?")>0)return;
	
	if( id.indexOf("chat-group-normal-chat.html")>=0 || id.indexOf("chat-chat.html")>=0 || id.indexOf("chat-group-chat.html")>=0 || id.indexOf("index-xunjia-chat.html")>=0 || id.indexOf("zd-chat.html")>=0){	
		var qs=id.lastIndexOf("=")+1; 
		console.log(qs);
		//同时清除未读消息数量
		//cid = plus.webview.getWebviewById('chat-index.html');
		cid = plus.webview.getWebviewById('xin-index.html');
		if(cid == null){
		}else{
			console.error("  $('#wd"+id.substr(qs,99) +"').html('0').hide(); ");				
			cid.evalJS("  $('#wd"+id.substr(qs,99) +"').html('0').hide(); ");	
		}
		
	}	
	
	console.log("正在打开页面：" + id);
	openw = plus.webview.getWebviewById(id);
	if(openw){//避免多次打开同一个页面
		//.return null;
		if(id == 'index-all.html'){
			openw.show();
			return;
		}
		if(id == 'index.html'){
			if(plus.webview.getWebviewById('index2.html') != null){
				plus.webview.getWebviewById('index2.html').close();	
			}			
		}
		if(id == 'index-map.html'){
			if(plus.webview.getWebviewById('index-list.html') != null){
				plus.webview.getWebviewById('index-list.html').close();	
			}			
		}
	 	if(id == 'chat-index.html'){
	 		openw.reload();
	 		setTimeout(function(){
	 			openw.show();
	 		},400);	 
	 		return;	 		
	 	}	 	
	 	if( id.indexOf("hat-group-normal-chat.html")>0 ){
	 		console.error("执行读取历史聊天记录");
	 		//openw.evalJS("getHistoryMsg(room_id);");
	 		openw.reload();
	 		setTimeout(function(){
	 			openw.show();
	 		},400);	 
	 		return;	
	 	}
	 	if( id.indexOf("hat-chat.html")>0 ){	 		
	 		//openw.evalJS("getHistoryMsg(room_id);");
	 		openw.reload();
	 		setTimeout(function(){
	 			openw.show();
	 		},400);	
	 		return;	
	 	}
	 	if( id.indexOf("hat-group-chat.html")>0 ){
	 		//openw.evalJS("getHistoryMsg(room_id);");
	 		openw.reload();
	 		setTimeout(function(){
	 			openw.show();
	 		},400);	 
	 		return;	
	 	}
	 	if( id.indexOf("ndex-xunjia-chat.html")>0 ){
	 		//openw.evalJS("getHistoryMsg(room_id);");
	 		openw.reload();
	 		setTimeout(function(){
	 			openw.show();
	 		},400);	 
	 		return;	
	 	}
	 	if( id.indexOf("d-chat.html")>0 ){
	 		//openw.evalJS("getHistoryMsg(room_id);");
	 		openw.reload();
	 		setTimeout(function(){
	 			openw.show();
	 		},400);	 		
	 		return;	
	 	}
		openw.close();
	}
	//plus.webview.close('newdrag');
	if(w.plus){
		wa&&(waiting=plus.nativeUI.showWaiting());
		ws=ws||{};
		ws.scrollIndicator||(ws.scrollIndicator='none');
		ws.scalable||(ws.scalable=false);
		var pre='';//'http://192.168.1.178:8080/h5/';
		openw=plus.webview.create(pre+id,id,ws);		
//		ns||openw.addEventListener('loaded',function(){//页面加载完成后才显示
//		setTimeout(function(){//延后显示可避免低端机上动画时白屏		
			if(myas != ''){
				openw.show(myas);
			}else{
				openw.show(as);	
			}			
			closeWaiting();
//		},100);
//		},false);
		openw.addEventListener('close',function(){//页面关闭后可再次打开
			openw=null;
		},false);
		return openw;
	}else{
		w.open(id);
	}
	return null;
};
w.openDoc=function(t,c){
	var d=plus.webview.getWebviewById('document');
	if(d){
		d.evalJS('updateDoc("'+t+'","'+c+'")');
	}else{
		d=plus.webview.create('/plus/doc.html','document',{zindex:9999,popGesture:'hide'},{preate:true});
		d.addEventListener('loaded',function(){
			d.evalJS('updateDoc("'+t+'","'+c+'")');
		},false);
	}
}
/**
 * 关闭等待框
 */
w.closeWaiting=function(){
	waiting&&waiting.close();
	waiting=null;
}
// 兼容性样式调整
var adjust=false;
function compatibleAdjust(){
	if(adjust||!w.plus||!domready){
		return;
	}	// iOS平台使用滚动的div
	if('iOS'==plus.os.name){
		var t=document.getElementById("dcontent");
		t&&(t.className="sdcontent");
		t=document.getElementById("content");
		t&&(t.className="scontent");
		//iOS8横竖屏切换div不更新滚动问题
		var lasto=window.orientation;
		window.addEventListener("orientationchange",function(){
			var nowo=window.orientation;
			if(lasto!=nowo&&(90==nowo||-90==nowo)){
				window.dcontent&&(0==dcontent.scrollTop)&&(dcontent.scrollTop=1);
				window.content&&(0==content.scrollTop)&&(content.scrollTop=1);
			}
			lasto=nowo;
		},false);
	}
	adjust=true;
};
w.compatibleConfirm=function(){
	plus.nativeUI.confirm('本OS原生层面不提供该控件，需使用mui框架实现类似效果。请点击“确定”下载Hello mui示例',function(e){
		if(0==e.index){
			plus.runtime.openURL("http://www.dcloud.io/hellomui/");
		}
	},"",["确定","取消"]);
}
// 通用元素对象
var _dout_=null,_dcontent_=null;
w.gInit=function(){
	_dout_=document.getElementById("output");
	_dcontent_=document.getElementById("dcontent");
};
// 清空输出内容
w.outClean=function(){
	_dout_.innerText="";
	_dout_.scrollTop=0;//在iOS8存在不滚动的现象
};
// 输出内容
w.outSet=function(s){
	_dout_.innerText=s+"\n";
	(0==_dout_.scrollTop)&&(_dout_.scrollTop=1);//在iOS8存在不滚动的现象
};
// 输出行内容
w.outLine=function(s){
	_dout_.innerText+=s+"\n";
	(0==_dout_.scrollTop)&&(_dout_.scrollTop=1);//在iOS8存在不滚动的现象
};
// 格式化时长字符串，格式为"HH:MM:SS"
w.timeToStr=function(ts){
	if(isNaN(ts)){
		return "--:--:--";
	}
	var h=parseInt(ts/3600);
	var m=parseInt((ts%3600)/60);
	var s=parseInt(ts%60);
	return (ultZeroize(h)+":"+ultZeroize(m)+":"+ultZeroize(s));
};
// 格式化日期时间字符串，格式为"YYYY-MM-DD HH:MM:SS"
w.dateToStr=function(d){
	return (d.getFullYear()+"-"+ultZeroize(d.getMonth()+1)+"-"+ultZeroize(d.getDate())+" "+ultZeroize(d.getHours())+":"+ultZeroize(d.getMinutes())+":"+ultZeroize(d.getSeconds()));
};
/**
 * zeroize value with length(default is 2).
 * @param {Object} v
 * @param {Number} l
 * @return {String} 
 */
w.ultZeroize=function(v,l){
	var z="";
	l=l||2;
	v=String(v);
	for(var i=0;i<l-v.length;i++){
		z+="0";
	}
	return z+v;
};
})(window);

</script>
   
   
    
	<script type='text/javascript' src='js/sm.js' charset='utf-8'></script>
	<script type='text/javascript' src='js/sm-extend.js' charset='utf-8'></script>
	<script type='text/javascript' src='js/template.js' charset='utf-8'></script>
	<script type="text/javascript" src="js/layer/layer.js" ></script>
	<script type="text/javascript" src="js/imgUpload/binaryajax.js" ></script>
    <script type="text/javascript" src="js/imgUpload/canvasResize.js" ></script>
    <script type="text/javascript" src="js/imgUpload/exif.js" ></script>
	<script type="text/javascript" src="js/lrz.all.bundle.js" ></script>
	<script type="text/javascript" src="js/iscroll4.js" ></script>
	
	<script>
		var send_text = false;
		var chat_type = 'text';
		var MIN_SOUND_TIME = 800;
		var i=1;
		var f1 = new Array();
		var prarm = '';
		var fromer = '';
		var self = '';
		var token = '';
		var record = [];
		var rootPath = '_doc/';		
		var room_id = ''; 
		var room_members = '';
		var user_type = '2';				//用户类型，2为顾客，1为店员,3为老板
		var private_index = 0;				//私聊窗口数量
		var max_private_count = 3;			//私聊窗口最大数量
		var msg_type = 'public';			//聊天状态，public为公聊，private为私聊
		var private_roomid = 0;				//私聊roomid，退出私聊时用到
		var private_room_member = '';		//私聊群内成员信息
		var private_user = '';				//私聊会员信息,点击私聊标签时赋值
		var do_history_room_id = [];		//已调取聊天记录的roomid
		var socket = '';
		var get_room_id_data = {
			'api_name':'chatgroup_findroomid',
			'token':'',
			'company_id':'',
			'cates_id':'',
			'type':4,
			'ids':'',
			'msg':'',
			'mtype':'',
		};
		var send_lng = '';
		var send_lat = '';
		var map = '';
		var is_first = true;		//是否第一次发话，用来判断是否执行创建roomid动作
		
		var position_lng = '';
		var position_lat = '';
		var position_addr = '';
		
		
		var private_room_id = '';
		var chat_list = [];
		var chat_intval = 0;		//读取聊天缓存定时器
		
		
		
		
		
		var promise_lng = '';		//诚信金经度
		var promise_lat = '';		//诚信金维度
		var promise_local = '';		//诚信金街道地址		
		var is_promist_page = 0;
		var promise_data = {
			'api_name':'deposit_add',
			'token':token,
			'price':0,
			'res':0,
			'local':'',
			'addr':'',
			'start':'',
			'end':'',
			'last':'',
			'foruserid':'',
			'note':''
		};
		var font_size = 0;
		var icon_width = 0;
		var icon_height = 0;
		var geoc = '';
		var orderid = '';			//支付订单id
		var paytype = '';			//支付类型，promise保证金支付，hongbao红包支付
		
		var token = localStorage.getItem('token');
		var param = $.myUtil().toQueryParams();
		var room_id = param['room_id'];
		var company_id = param.company_id;
		
		var time2 = param.time2;		
		var history_back = false;		
		var has_history = true;
		var history_result = '';		
		var is_end = false;
		
		var room_detail = JSON.parse(localStorage.getItem('room_detail'));
		if(room_detail){
			$("#title").html(room_detail.room_name);	
		}		
		var other_user = '';
		var myScroll = '';
		var now_date = (new Date()).format("y-m-d");	//当天日期
		var day_index = 1;								//天数
		var is_load_history = false;					//是否加载历史信息
		var is_load = false;
		var no_history = false;
		
		if(time2){
			now_date = time2;
		}
		
		var userinfo = '';
		
		
		var promist_html = '<div class="dialog-container">'+
					'<div class="promise-dialog">'+
						'<div class="promise-dialog-head">'+
							'<p>136****5678 承诺诚信金 </p>'+
							'<p>￥10 元</p>'+
							'<p>您是否同意出具同样金额的诚信金作为违约赔偿</p>'+
						'</div>'+
						'<div class="promise-dialog-body">'+
							'<div class="inner-line">'+
								'<div class="inner-label">约定位置</div>'+
								'<div class="inner-content">南阳建西路口</div>'+
							'</div>'+
							'<div class="inner-line">'+
								'<div class="inner-label">约定时间</div>'+
								'<div class="inner-content">'+
		        					'<div class="inner-top">从 2017-05-27 12:22</div>'+
		        					'<div class="inner-bottom">至 2017-05-28 09:12</div>'+
		        				'</div>'+
							'</div>'+
							'<div class="inner-line">'+
								'<div class="inner-label">备注</div>'+
								'<div class="inner-content">发牢骚的空间疯狂就冻死了分开多久</div>'+	
							'</div>'+
							'<div class="inner-line">'+
								'<div class="inner-label">违约时间</div>'+
								'<div class="inner-content">2017-05-28 12:00</div>'+
							'</div>'+
						'</div>'+
						'<div class="promise-dialog-foot">'+
							'<span>拒绝</span>'+
							'<span>同意</span>'+
						'</div>'+
					'</div>'+
				'</div>';	
		
		
		function showPromiseConfirm(promise,agreeFn,failedFn){
			
			$("#promist_show").html(template('promiseT',{item:promise}));
			$(".backdrop").show();
			$(".promise-dialog").show();
			$("#promise_dialog_agree").click(agreeFn);
			$("#promise_dialog_failed").click(failedFn);
			$(".backdrop").click(function(){
				$(this).hide();
				$(".promise-dialog").hide();
			});
		}
		
		function initBmap(){
			font_size = parseFloat($("html").css('font-size'));
			icon_width = font_size*4;
        	icon_height = font_size*4;
			device = JSON.parse(localStorage.getItem('device'));
			phone_local = device.phone_local.split(',');			
			map = new BMap.Map("bmap");          // 创建地图实例  
			point = new BMap.Point(phone_local[0], phone_local[1]);  // 创建点坐标			
			map.centerAndZoom(point, 15);
			myIcon = new BMap.Icon("images/chat-map-point.png", new BMap.Size(icon_width,icon_height));
			marker = new BMap.Marker(new BMap.Point(phone_local[0], phone_local[1]),{icon:myIcon});
			map.addOverlay(marker);
			geoc = new BMap.Geocoder();
			geoc.getLocation(point, function(rs){				
				addComp = rs.addressComponents;
				now_local_info = addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber				
				getPois(point.lat,point.lng);
			});			
			map.addEventListener("click", showInfo);
		}
		
		function addMarker(point){
			map.clearOverlays();
			myicon = new BMap.Icon("images/chat-map-point.png", new BMap.Size(icon_width,icon_height));			
			map.addOverlay(new BMap.Marker(point),{icon:myicon});			
		}
		
		function showInfo(e){
			addMarker(e.point)
			pt = e.point;
			getPois(pt.lat,pt.lng);
			geoc.getLocation(pt, function(rs){
				var addComp = rs.addressComponents;
				now_local_info = addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber					
				if(is_promist_page){
					promise_lng = pt.lng;
					promise_lat = pt.lat;
					promise_local = now_local_info;
					$("#promise_position").html(promise_local);
				}
			});
		}
		
		function getPois(lat,lng){
			api_url = 'http://api.map.baidu.com/geocoder/v2/?location='+lat+','+lng+'&output=json&pois=10&ak=C8Pn598qtNvbvOFXuLhN8z2j';			
			$.ajax({
				url :api_url,
				type:'GET',
				dataType :'JSON',
				success:function(res){
					res = JSON.parse(res);						
					if(res.status == 0){
						$("#poisList").html(template('poisListT',{list:res.result.pois}));						
						$(".position").click(function(){
							type = $(this).attr('data-type');
							send_lng = $(this).attr('data-lng');
							send_lat = $(this).attr('data-lat');
							addr = $(this).attr('data-addr');
							name = $(this).attr('data-name');
							$("#poisList").find('i').attr('class','pull-right icon icon-cb-uncheck');
							$(this).find('i').attr('class','pull-right icon icon-cb-check');
							if(is_promist_page){
								promise_lng = send_lng
								promise_lat = send_lat;
								promise_local = addr+name;
								$("#promise_position").html(promise_local+name);
							}else{
								position_lng = send_lng;
								position_lat = send_lat;
								position_addr = addr;
							}
							addMarker(new BMap.Point(send_lng, send_lat));
						});
					}
				}
			})
		}		
		
		
		$(function(){
			obj = {};
			obj[room_id] = [];
			chat_list.push(obj);
			
			$.myUtil().ajax({
				data:{
					'api_name':'chatgroup_qunlists',
					'token':token,
					'room_id':room_id
				},beforeFn:function(){}
			}).done(function(res){
				if(res.state == 'ok'){
					$("#title").html(res.data.room_name);
					localStorage.setItem(room_id,JSON.stringify(res.data.room_members));
					localStorage.setItem('room_detail',JSON.stringify(res.data));
					//clicked('chat-group-normal-chat.html?room_id='+roomid);
				}
			})			
			
			$("#choose-position").click(function(){
				$.router.load("#chat-positioin");
				position_is_open = true;
			})
			
			$(".hongbao-page-close").click(function(){
//				$("#hb_money").html(0.00);
//				$("#hb_nickname").html("");
//				$("#get_hongbao").hide();
//				$("#hongbao_log").hide();
//				$("#hongbao_log").html('');
				$.router.back();

			});	
			
			function findOther(id){
				$.myUtil().ajax({
					data:{
						'api_name':'userinfo_findother',
						'token':token,
						'user_id':id
					},
					beforeFn:function(){}
				}).done(function(res){
					if(res.state == 'ok'){
						fromer = res.data;	
					}
					
				});
			}			
		});
		
		
		document.addEventListener('plusready',function(){
			setTimeout("initBmap()",3000);
			console.log(room_id);
			socket = io.connect('ws://123.57.172.113:3000');
			socket.on('connect',function(e){
				socket.emit('login',token,'baozheng',function(status,content){
					if(status == 0){
						console.log('连接失败');
					}else{
						console.log('连接成功');
						socket.emit('jinrufangjian',token,0,0,room_id,0,function(){});
					}
				});
			});
			radio_nw = plus.webview.getWebviewById('radio');
			token = localStorage.getItem('token');
			if(token == '' || token == null || token == undefined){
				$.myUtil().alert_msg('身份已过期，请重新登录',function(){localStorage.clear();clicked('login.html');});
			}
			userinfo = JSON.parse(localStorage.getItem('userinfo'));
			from_id = prarm['from'];
//			$(".icon-close").click(function(){
//				url = $(this).attr('data-url');
//				url += '?room_id='+room_id;
//				clicked(url);
//			});
			
			room_members = localStorage.getItem(room_id);
			if(room_members != null && room_members != undefined){
				room_members = JSON.parse(room_members);
			}
			
			//getHistoryMsg(room_id);
			getHistoryMsg(room_id);
			$(".icon-close").click(function(){
				url = $(this).attr('data-url');
				url += '?room_id='+room_id;
				clicked(url);
			});
			
			$(".mybackbtn").click(function(){
				xinPage = plus.webview.getWebviewById('xin-index.html');
				if(xinPage){
					socket.disconnect();
					xinPage.evalJS('refreshPage()');
					setTimeout(function(){
						back();
					},300);
				}
			});
			
			$("#position_send").click(function(){
				if(is_promist_page == 1){
					$.router.load("#zd-chat-promise");
				}else{
					send({
                    	sender: 'self',
						type: 'position',
						mtypes:6,
						content: position_lng+","+position_lat,
						show_path:'http://api.map.baidu.com/staticimage/v2?ak=C8Pn598qtNvbvOFXuLhN8z2j&center='+position_lng+","+position_lat+'&width=512&height=360&zoom=14&markers='+position_lng+","+position_lat+'&dpiType=ph',
						logo_src: self.head_pic
                    }) 
				}				
			})
			
			$("#promise_pay_btn").click(function(){
				money = $("#promise_money").val();
				if(money == ''){
					$.myUtil().alert_msg('请填写约定的诚信金额');return;
				}
				if(money <= 0){
					$.myUtil().alert_msg('请填写正确的诚信金额');return;
				}
				start = $("#start_time").val();
				end = $("#end_time").val();
				float_time = $("#float_time").val();
				last_time = $("#last_time").val();
				note = $("#note").val();
				
				promise_data.token = token;
				promise_data.price = money;
				promise_data.local = promise_lng+","+promise_lat;
				promise_data.start = start;
				promise_data.end = end;
				promise_data.last = last_time;
				promise_data.foruserid = self.intval_id;
				promise_data.note = note;
				promise_data.addr = promise_local;
				
				$.myUtil().ajax({
					data:promise_data,
					beforeFn:function(){}
				}).done(function(res){
					console.log(JSON.stringify(res));
					if(res.state == 'ok'){
						orderid = res.data.deposit_id;
						paytype = 'promise'
						$(".backdrop").show();
						$("#promise_pay_form").show();
					}else{
						$.myUtil().alert_msg(res.msg);return;
					}
				})
			})
			
			$("#hongbao_money").on('keyup',function(){
				if(this.value > 0){
					$("#hongbao_total").html(this.value);
				}else{
					$("#hongbao_total").html('0.00');
				}
			})
			
			$("#hongbao_pay_btn").click(function(){
				money = $("#hongbao_money").val();
				num = $("#hongbao_num").val();
				if(money == ''){
					$.myUtil().alert_msg('请填写红包金额');return;
				}
				if(money <= 0){
					$.myUtil().alert_msg('请填写正确的红包金额');return;
				}
				
				if(num == ''){
					$.myUtil().alert_msg('请填写红包数量');return;
				}
				if(num <= 0){
					$.myUtil().alert_msg('请填写正确的红包数量');return;
				}
				
				$.myUtil().ajax({
					data:{
						'api_name':'luckymoney_add',
						'token' : token,
						'price':money,
						'pnum':num,
						'roomid':room_id,
						'title':'',
						'res':0,
						'aid':0
					},
				}).done(function(res){
					layer.closeAll();
					console.log(JSON.stringify(res));
					if(res.state == 'ok'){
						orderid = res.data.luckyid;
						paytype = 'hongbao'
						$(".backdrop").show();
						$("#promise_pay_form").show();
					}else{
						$.myUtil().alert_msg(res.msg);
					}
				})
			})
			
			
			
			
			
			$.myUtil().ajax({data:{'api_name':'userinfo_find','token':token},beforeFn:function(){}}).done(function(res){
				self = res.data;
				for(var i in room_members){					
					if(i == self.intval_id){
						user_type = room_members[i].type;
						break;
					}
				}				
			});
			
//			$.myUtil().ajax({data:{'api_name':'userinfo_findother','token':token,'user_id':from_id},beforeFn:function(){}}).done(function(res){
//				fromer = res.data;
//				//$(".title").html(fromer.nickname);
////				getHistoryMsg(room_id);				
//			});
			$("#msg-content").on('input',function(){
				//MobileFrame.saveMsg(1,1,'aaaaaa');
				if(this.value != ''){
					$("#msg-more").attr('src','images/icon/icon-chat-send.png');
					send_text = true;
				}else{
					$("#msg-more").attr('src','images/icon/icon-chat-more.png');
					send_text = false;
				}
			});
			
			$('.hongbao-back').click(function(){
				$.router.back();
			})
			
			radio_nw = plus.webview.getWebviewById('radio');						
			var stopTimer = null;
			$("#chat-type").on('click',function(){
				if(chat_type == 'text'){
					$("#msg-content").hide();
					$("#msg-sound").show();
					$(this).attr('src','images/icon/icon-chat-keybord.png');
					chat_type = 'sound';
				}else if(chat_type == 'sound'){
					$("#msg-content").show();
					$("#msg-sound").hide();
					$(this).attr('src','images/icon/icon-chat-sound.png');
					chat_type = 'text';
				}
			})
		    
		    
		    $("#msg-more").on('click',function(){
		    	if(send_text){
		    		send({
						sender: 'self',
						type: 'text',
						mtypes:1,
						content: $("#msg-content").val(),
						logo_src: self.head_pic
					});
					$("#msg-content").val('');
					$("#msg-more").attr('src','images/icon/icon-chat-more.png');
					send_text = false;
		    	}else{
		    		if(!$("footer").hasClass('chat-slideUp') && $("footer").classList == undefined){
			    		$("footer").attr('class','chat-slideUp');
			    	}else if($("footer").hasClass('chat-slideUp')){
			    		$("footer").attr('class','chat-slideDown');
			    	}
		    	}
		    	
		    	
		    	
		    })
			 
			var setSoundAlertVisable=function(show){
				if(show){
					ui.boxSoundAlert.style.display = 'block';
					ui.boxSoundAlert.style.opacity = 1;
				}else{
					ui.boxSoundAlert.style.opacity = 0;
					//fadeOut 完成再真正隐藏
					setTimeout(function(){
						ui.boxSoundAlert.style.display = 'none';
					},200);
				}
			};
			var recordCancel = false;
			var recorder = null;
			var audio_tips = document.getElementById("audio_tips");
			var startTimestamp = null;
			var stopTimestamp = null; 
			var stopTimer = null;	
			
			
			var send = function(msg) {
				msg.user = self.intval_id;
				msg.userid = self.intval_id;				
				msg.room_id = room_id;
				if(private_room_id != ''){
					msg.room_id = private_room_id;
				}
				msg.mid = self.intval_id+Date.parse(new Date());
				filename = '';
				
				if(msg.type == 'text'){
					$("#msg-content").val('');
				}
				//发送到服务器
//				toRobot(msg.content);
				mtype = 1;
				if(msg.type == 'face'){
					mtype = 2;
				}else if(msg.type == 'image'){
					mtype = 3;
				}else if(msg.type == 'sound'){
					mtype = 4;
				}else if(msg.type == 'video'){
					mtype = 5;
				}else if(msg.type == 'position'){
					mtype = 6;
				}else if(msg.type == 'hongbao'){
					mtype = 7;
				}else if(msg.type == 'share_card'){
					mtype = 12;
				}else if(msg.type == 'promise'){
					mtype = 22;
				}else if(msg.type == 'notice'){
					mtype = 30;
				}
				send_room_id = room_id;
				userid = company_id == 0 ? self.intval_id : company_id;  
//				console.log('sendmsg("'+token+'","'+fromer['user_id']+'","'+mtype+'","0","'+msg.content+'");');
				radio_nw.evalJS('sendmsg("'+token+'",'+userid+',"'+mtype+'","'+send_room_id+'",\''+msg.content+'\');');				
				//chat_type = 'text';				
				if(msg.type == 'image'){
					filename = msg.content+'m.jpg';
					msg.content = "http://www.quweilai.cn/new_api/res/"+self.intval_id+"/"+msg.content+"m.jpg";
				}else if(msg.type == 'sound'){
					filename = msg.content+'.amr';
					msg.show_path = plus.io.convertLocalFileSystemURL(rootPath + msg.type + '/'+msg.content+'.amr');
				}else if(msg.type == 'video'){
					filename = msg.content+'.mp4';
				}else if(msg.type == 'face'){
					msg.content = "images/emoji/"+msg.content+".gif";
				}else if(msg.type == 'position'){
					msg.content = 'http://api.map.baidu.com/staticimage/v2?ak=C8Pn598qtNvbvOFXuLhN8z2j&center='+msg.msg+'&width=512&height=360&zoom=14&markers='+msg.msg+'&dpiType=ph';
				}else if(msg.type == 'hongbao'){						
					arr = msg.content.split('@@');
					id = arr[0];
					title = arr[1];
					msg.objid = id;
					msg.title = title;
					msg.show_path = msg.content;
					msg.mtypes = mtype;
				}else if(msg.type == 'promise'){
					//msg.content = 'http://api.map.baidu.com/staticimage/v2?ak=C8Pn598qtNvbvOFXuLhN8z2j&center='+msg.msg+'&width=512&height=360&zoom=14&markers='+msg.msg+'&dpiType=ph';
				}
				console.log(JSON.stringify(msg));
				saveMsg(msg);
				
				record.push(msg);
				bindMsgList();
			};
			
			var saveMsg = function(msg){
				console.log(JSON.stringify(msg));
				MobileFrame.plusReady(function(){
					//1、已roomid为文件夹【000000100001000000100002】，该文件夹下创建留言缓存文件，以天为名字【20170510.txt】
					//	私聊roomid为自己的id和对方的id拼接，群聊id内包含c，为自己id和公司分类id拼接【00000c100001000000100003】
					//2、判断roomid文件是否存在，判断当天文件是否存在
					//3、打开缓存文件，没有的话创建该文件，写入缓存内容，如有资源信息，保存资源id
					plus.io.resolveLocalFileSystemURL( '_doc', function( fs ) {
						console.log(fs.fullPath);
						fs.getDirectory( self.intval_id+'/msg', {create:true,exclusive:false}, function(dir){
	//						console.log('1、msg文件夹打开');
							dir.getDirectory(msg.room_id,{create:true,exclusive:false},function(room_dir){
	//							console.log("2、打开"+msg.room_id+"文件夹");
								file_name = (new Date()).format('y-m-d')+".cx";
								room_dir.getFile(file_name,{create:true}, function(fileEntry){
	//								console.log("3、获取聊天缓存文件"+file_name);
									fileEntry.createWriter( function ( writer ) {
	//									console.log("4、创建文件写入对象");
										writer.onwrite = function ( e ) {
											console.log( '['+fileEntry.fullPath +"] Write data success!" );
										};
										writer.onerror=function(e){
											console.log( '['+fileEntry.fullPath +"] Write data error!");										
										};										
										// Write data to the end of file.										
										writer.seek( writer.length );
	//									console.log("5、写入文件内容"+JSON.stringify(msg));
										writer.write(JSON.stringify(msg)+"|");
									},
									function ( e ) {
										console.log( 'create error!' + e.message );										
									});
								});
							},function(err){
								console.log('roomid文件夹读取失败');
							})
						},function(err){
							console.log(JSON.stringify(err));
						});
					}, function ( e ) {
						console.log( "Request file system failed: " + e.message );
					} )
				});
			};
			
			
			
			
			
			
			
			ui.boxMsgSound.addEventListener("touchstart", function(e) {
//				console.log("start....");
				e.preventDefault();
			});
			
			ui.boxMsgSound.addEventListener('longTap', function(event) {
				//console.log('hold');return;
				recordCancel = false;
				if(stopTimer)clearTimeout(stopTimer);
				audio_tips.innerHTML = "手指上划，取消发送";
				ui.boxSoundAlert.classList.remove('rprogress-sigh');
				setSoundAlertVisable(true);
				recorder = plus.audio.getRecorder();				
				if (recorder == null) {
					plus.nativeUI.toast("不能获取录音对象");
					return;
				}
				startTimestamp = (new Date()).getTime();
				recorder.record({
					filename: "_doc/audio/"
				}, function(path) {					
					if (recordCancel) return;
					
					sound_file = path;
                	uploadFile({'api_name':'upload_add','token':token},path,function(res){
                		res = typeof res == 'string' ? JSON.parse(res):res;
                		if(res.state == 'ok'){
                			resid = res.data.resid;
                			s_sound_list = [];
	                    	s_sound_list = JSON.parse(localStorage.getItem('s_sound_list')) || [];
	                    	s_sound_list.push({resid:res.data.resid,'info':path});
	                    	send({
	                        	sender: 'self',
								type: 'sound',
								mtypes : 4,
								content: resid,
								show_path:path,
								logo_src: self.head_pic
	                       });	                        
	                        plus.io.resolveLocalFileSystemURL( '_doc/sound', function(newDir){	                        	
	                        	plus.io.resolveLocalFileSystemURL( path, function(fileEntry){
		                        	fileEntry.copyTo( newDir, resid+'.amr', function( entry ){
//										plus.console.log("New Path: " + entry.fullPath);
									}, function( e ){
										console.log(JSON.stringify(e));
									});								
								})
	                        }, function(err){
	                        	console.log(JSON.stringify(e));
	                        });
	                        
	                        
                		}
                	},true);
				}, function(e) {
					plus.nativeUI.toast("录音时出现异常: " + e.message);
				});
			}, false);
			ui.boxMsgSound.addEventListener('drag', function(event) {
//				console.log('drag');return;
				console.log('111');
				if (Math.abs(event.detail.deltaY) > 50) {
					if (!recordCancel) {
						recordCancel = true;
						if (!audio_tips.classList.contains("cancel")) {
							audio_tips.classList.add("cancel");
						}
						audio_tips.innerHTML = "松开手指，取消发送";
					}
				} else {
					if (recordCancel) {
						recordCancel = false;
						if (audio_tips.classList.contains("cancel")) {
							audio_tips.classList.remove("cancel");
						}
						audio_tips.innerHTML = "手指上划，取消发送";
					}
				}
			}, false);
			ui.boxMsgSound.addEventListener('touchend', function(event) {
//				console.log('release');
				if (audio_tips.classList.contains("cancel")) {
					audio_tips.classList.remove("cancel");
					audio_tips.innerHTML = "手指上划，取消发送";
				}
				//
				stopTimestamp = (new Date()).getTime();
				if (stopTimestamp - startTimestamp < MIN_SOUND_TIME) {
					audio_tips.innerHTML = "录音时间太短";
					ui.boxSoundAlert.classList.add('rprogress-sigh');
					recordCancel = true;
					stopTimer=setTimeout(function(){
						setSoundAlertVisable(false);
					},800);
				}else{
					setSoundAlertVisable(false);
				}
				recorder.stop();
			}, false);
			ui.boxMsgSound.addEventListener("touchstart", function(e) {
				//console.log("start....");
				e.preventDefault();
			});
			
			$("#choose-pic").on('click',function(){
				close_foot();
				galleryImg();
			});
			
			
			function galleryImg() {			
		        //每次拍摄或选择图片前清空数组对象
		        f1.splice(0, f1.length);        
		        // 从相册中选择图片
		        //mui.toast("从相册中选择一张图片");
		        plus.gallery.pick(function(path) {
		            showImg(path);
		        }, function(e) {
		            //mui.toast("取消选择图片");
		            $.myUtil().toast('取消选择');
		        }, {
		            filter: "image",
		            multiple: false
		        });
		    }
			
			function showImg(url) {
			    // 兼容以“file:”开头的情况
			    if (0 != url.toString().indexOf("file://")) {
			        url = "file://" + url;
			    }
			    var _div_ = document.getElementsByClassName("showimg")[0];
			    var _img_ = new Image();
			    _img_.src = url; // 传过来的图片路径在这里用。
			    _img_.onclick = function() {
			        plus.runtime.openFile(url);
			    };
			    _img_.onload = function() {
			        var tmph = _img_.height;
			        var tmpw = _img_.width;
			        var isHengTu = tmpw > tmph;
			        var max = Math.max(tmpw, tmph);
			        var min = Math.min(tmpw, tmph);
			        var bili = min / max;
			        if (max > 1200) {
			            max = 1200;
			            min = Math.floor(bili * max);
			        }
			        tmph = isHengTu ? min : max;
			        tmpw = isHengTu ? max : min;
	//		        _img_.style.border = "1px solid rgb(200,199,204)";
	//		        _img_.style.margin = "10px";
	//		        _img_.style.width = "150px";
	//		        _img_.style.height = "150px";
			        _img_.onload = null;
			        plus.io.resolveLocalFileSystemURL(url, function(entry) {
			        	plus.nativeUI.showWaiting('图片压缩中');
			            entry.file(function(file) {		                
			                canvasResize(file, {
			                    width: tmpw,
			                    height: tmph,
			                    crop: false,
			                    quality: 50, //压缩质量
			                    rotate: 0,
			                    callback: function(data, width, height) {
			                        f1.push(data);
			                        _img_.src = data;
			                        $.myUtil().ajax({
			                        	data:{
			                        		'api_name':'upload_add',
			                        		'token':token,
			                        		'pich5':data
			                        	},
			                        	beforeFn:function(){}
			                        }).done(function(res){
			                        	s_img_list = [];			                        	
			                        	s_img_list = JSON.parse(localStorage.getItem('s_img_list')) || [];
			                        	s_img_list.push({resid:res.data.resid,'info':data});
			                        	localStorage.setItem('s_img_list', JSON.stringify(s_img_list));
			                        	send({
				                        	sender: 'self',
											type: 'image',
											mtypes:3,
											content: res.data.resid,
											show_path:data,
											logo_src: self.head_pic
				                        }) 
			                        	
			                        	
//			                        	plus.io.resolveLocalFileSystemURL(url,function(newFile){
//			                        		dir = newFile.fullPath.substr(0,newFile.fullPath.lastIndexOf('/')+1);
//			                        		file_name = newFile.fullPath.substr(newFile.fullPath.lastIndexOf('/')+1);
//			                        		console.log(dir);
//			                        		console.log(file_name);
			                        		plus.io.resolveLocalFileSystemURL( '_doc/image', function(newDir){
					                        	plus.io.resolveLocalFileSystemURL( url, function(fileEntry){
						                        	fileEntry.copyTo( newDir, res.data.resid+'m.jpg', function( entry ){						                        		
//														plus.console.log("New Path: " + entry.fullPath);
													}, function( e ){
														console.log(JSON.stringify(e));
													});								
												},function(err){
													console.log("打开目录失败");
												})
					                        }, function(err){
					                        	console.log(JSON.stringify(e));
					                        });
			                        		
//			                        	})
			                        	
			                        	
			                        	
			                        });
			                        
			                        //$("#thumb_a").html(_img_);
			                        //$("#img_thumbs").attr('src',url);
			                        plus.nativeUI.closeWaiting();
			                        //imgupgrade();
			                    }
			                });
			            });
			        },
			        function(e) {
			            plus.nativeUI.closeWaiting();
			            
			        });
			    };
			};
	
	        function imgupgrade() {
	            //mui.toast('后台联调时启用上传功能');
	            //return;
	            var wt = plus.nativeUI.showWaiting();
	            var url = '后台地址';
	            var dataType = 'json';
	            //发送数据  
	            var data = {
	                files1: f1[0] //base64数据        
	            };
	            $.myUtil().ajax({data:{'api_name':'upload_add','pich5':f1[0],'token':token},beforeFn:function(){}}).done(function(res){
	            	plus.nativeUI.closeWaiting();
//	            	console.log(res);
	            	if(typeof res == 'string'){
	            		res = JSON.parse(res);
	            	}                	
	            	$.myUtil().toast(res.msg);
	            	imgPath = res.data.path;
//	            	console.log(JSON.stringify({'api_name':'userinfo_set','token':token,'head_portrait':res.data.resid}));
	            	$.myUtil().ajax({data:{'api_name':'userinfo_set','token':token,'head_portrait':res.data.resid},beforeFn:function(){}}).done(function(resource){
	            		layer.closeAll();	            		
	            		userinfo.head_pic = imgPath;
	            		localStorage.removeItem('userinfo');
	            		localStorage.setItem('userinfo',JSON.stringify(userinfo));
	            	});
	            });
	            //mui.post(url, data, success, dataType);
	        }
	        //成功响应的回调函数
	        var success = function(response) {
	            plus.nativeUI.closeWaiting();
	            if (response != null) {
	                alert("上传成功");
	            }
	        }
	        
	        function getImage(){				
				var cmr = plus.camera.getCamera();
				cmr.captureImage(function(p){				
					plus.io.resolveLocalFileSystemURL(p, function(entry){
						//createItem(entry);
						showImg(entry.toLocalURL());
					}, function(e){
						console.log('读取拍照文件错误：'+e.message);
					});
				}, function(e){
					console.log('失败：'+e.message);
				}, {filename:'_doc/camera/',index:1});
			}
	       	
	       	$("#choose-photo").on('click',function(){
	       		close_foot();
	       		getImage();
	       	});
	       	
	       	function getVideo(){
//				console.log('开始录像：');
				var cmr = plus.camera.getCamera();
				cmr.startVideoCapture(function(p){
//					console.log('成功：'+p);
					plus.io.resolveLocalFileSystemURL(p, function(entry){
						//createItem(entry);
//						console.log(entry.toLocalURL());
						uploadFile({'api_name':'upload_add','token':token},entry.toLocalURL(),function(res){							
	                		res = typeof res == 'string' ? JSON.parse(res):res;
	                		if(res.state == 'ok'){
	                			resid = res.data.resid;
	                			s_video_list = [];			                        	
	                        	s_video_list = JSON.parse(localStorage.getItem('s_video_list')) || [];
	                        	s_video_list.push({resid:res.data.resid,'info':entry.toLocalURL()});
	                        	localStorage.setItem('s_video_list', JSON.stringify(s_video_list));
		                    	send({
		                        	sender: 'self',
									type: 'video',
									mtypes:5,
									content: res.data.resid,
									show_path:entry.toLocalURL(),
									logo_src: self.head_pic
		                        })
		                    	plus.io.resolveLocalFileSystemURL( '_doc/video', function(newDir){				                        		
		                        	plus.io.resolveLocalFileSystemURL( entry.toLocalURL(), function(fileEntry){
//		                        		console.log(fileEntry.fullPath);
			                        	fileEntry.copyTo( newDir, res.data.resid+'.mp4', function( entry ){						                        		
											plus.console.log("New Path: " + entry.fullPath);
										}, function( e ){
											console.log(JSON.stringify(e));
										});								
									},function(err){
										console.log("打开目录失败");
									})
		                        }, function(err){
		                        	console.log(JSON.stringify(e));
		                        });
	                		}
	                	},true);
					
					}, function(e){
						console.log('读取录像文件错误：'+e.message);
					} );
				}, function(e){
					console.log('失败：'+e.message);
				}, {filename:'_doc/camera/',index:i});
			}
			$("#choose-video").on('click',function(){
				close_foot();
	       		getVideo();
	       	});
	       	
	       	$("#choose-card").click(function(){
	       		close_foot();
	       		send({
                	sender: 'self',
					type: 'share_card',
					mtypes : 12,
					content: JSON.stringify({'thumb':self.head_pic,'title':self.nickname,'desc':'【分享名片】点击查看名片','id':self.intval_id,'type':0,'share_type':'share_card','share_url':'index-card.html?id='+self.intval_id}),
					show_path:path,
					logo_src: self.head_pic
               });
	       	})
	       	
	       	
			function uploadFile(params,files,successCall,wait) {
				timestamp=new Date().getTime();
//				console.log('开始上传----'+timestamp);
				var netStatus = plus.networkinfo.getCurrentType();
				if (netStatus == plus.networkinfo.CONNECTION_NONE){
					plus.nativeUI.closeWaiting();
					mui.toast('无网络链接，请检查网络设置！');
					return;
				}				
				var url = $.apiPath;
				if (wait === undefined) {
					wait = true;
				}
				if (wait) {
					var waitTitle = '上传中...';
					plus.nativeUI.showWaiting(waitTitle, {
						padlock: true
					});
				}
				var upload = plus.uploader.createUpload(url, {
					method: 'post',
					timeout:300000,
					retryInterval:60000
				},
				function(t, status) {
					timestamp=new Date().getTime();
//					console.log('上传完毕----'+timestamp);
					if (wait) {
						plus.nativeUI.closeWaiting();
					}
					if (status == 200) {						
//						console.log("上传成功："+status);
//						console.log(t.responseText);
		//				plus.storage.setItem("uploader", t.responseText); //添加数据存储到应用中
						if (typeof successCall == 'function') {
							successCall(JSON.parse(t.responseText));
						}
					} else {
//						console.log(status);
						if (wait) {
							plus.nativeUI.closeWaiting();
						}
						mui.toast('亲，问题上传失败');
		//				outLine("上传失败：" + status);
					}
				});
				//upload.addData("token", token);
				for(i in params){
					upload.addData(i,params[i]);
				}
				upload.setRequestHeader("Content-Type",'multipart/form-data');
				upload.addFile(files, {'key':'rsfl'});
//				for (var i = 0; i < files.length; i++) {
//					upload.addFile(files[i].path, {
//						key: files[i].name
//					});
//				}
				upload.start();
			}
			  
			
			setInterval(function(){
				getCacheMsg(room_id);
			},1000);
			
			function startCacheMsgIntval(roomid){
				chat_intval = setInterval(function(){					
					getCacheMsg(roomid);
				},1000);
			}			
			
			function getCacheMsg(roomid){
				
				MobileFrame.getCache(userinfo.intval_id,roomid,function(result){
					
					var msgStr = [];
					console.error(result);
					for(i in result){
						if(result[i] == '')continue;
						msg = JSON.parse(result[i]);
						memberinfo = getMemberInfo(msg.user);
						
//						console.log(msg.user);
						console.error(JSON.stringify(memberinfo));
						type = $.getMsgType(msg.mtypes);
						if(private_room_id != ''){
							msg.logo_src = private_user.pic;
							msg.nickname = private_user.nickname;
						}else{
							msg.logo_src = memberinfo.head_portrait;
							msg.nickname = memberinfo.nickname;	
						}
						msg.content = msg.msg;
						msg.type = type;
						msg.sender = 'other';
						msg.user_id = msg.user;
						msg.userid = msg.user;
						
						if(type != 'text'){
							if(type == 'sound'){
								msg.content = "http://www.quweilai.cn/new_api/res/"+msg.user+"/"+msg.msg+".amr";
								msg.show_path = msg.content
//								msg.show_path = plus.io.convertLocalFileSystemURL(rootPath + msg.type + '/'+msg.user+'.amr');
							}else if(type == 'video'){
								msg.content = "http://www.quweilai.cn/new_api/res/"+msg.user+"/"+msg.msg+".mp4";
								msg.show_path = msg.content
//								msg.show_path = plus.io.convertLocalFileSystemURL(rootPath + msg.type + '/'+msg.user+'.mp4');
							}else if(type == 'image'){
								msg.content = "http://www.quweilai.cn/new_api/res/"+msg.user+"/"+msg.msg+"m.jpg";
								msg.show_path = msg.content
//								msg.show_path = plus.io.convertLocalFileSystemURL(rootPath + msg.type + '/'+ msg.user +'m.jpg');
							}else if(type == 'face'){
								msg.content = "images/emoji/"+msg.msg+".gif";
								msg.show_path = msg.content
							}
						}
						msgStr.push(JSON.stringify(msg));
						console.log(JSON.stringify(msg));
						record.push(msg);
						bindMsgList();
					}
					
					file_name = (new Date()).format('y-m-d')+".cx";
					MobileFrame.writeTxt('_doc/'+userinfo.intval_id+'/msg/'+msg.room_id+'/',file_name,msgStr.join("|"));					
				});
			}
			
			var pwd_index = 0;
			var pass = '';
			var is_check = false;
			$(".nub_ggg li a").click(function(){
				pwd_index++;
				num = $(this).html();				
				if(pwd_index<6){
					$(".mm_box li").eq(pwd_index-1).addClass("mmdd");
					pass = pass+num;
				}else{
					if(is_check){
						return;
					}
					is_check = true;
					pass = pass+num;
					$(".mm_box li").eq(pwd_index-1).addClass("mmdd"); 
					setTimeout(function(){
						//location.href="cg.html";
						pay_data = {
							'token':token
						};
						api_name = '';
						if(paytype == 'promise'){
							pay_data.api_name = 'deposit_pay';
							pay_data.depositid = orderid;
						}else if(paytype == 'hongbao'){
							pay_data.api_name = 'luckymoney_apppay';
							pay_data.luckyid = orderid;
						}
						pay_data.paypass = pass;
						$.myUtil().ajax({
							data:pay_data
						}).done(function(res){
							layer.closeAll();
							pwd_index = 0;
							pass = '';
							is_check = false;
							$.myUtil().alert_msg(res.msg,function(){
								console.log(JSON.stringify(res));
								if(res.state == 'ok'){
									$(".backdrop").hide();
									$("#promise_pay_form").hide();									
									if(paytype == 'promise'){
										send({
											sender: 'self',
											type: 'promise',
											content: orderid+'##'+JSON.stringify(promise_data),
											logo_src: self.head_pic
										});	
									}else if(paytype == 'hongbao'){										
										send({
											sender: 'self',
											type: 'hongbao',
											content: orderid+'@@恭喜发财，大吉大利',
											logo_src: self.head_pic
										});
										
									}									
									$(".backdrop").hide();
									$("#promise_pay_form").hide();
									pwd_index = 0;
									pass = '';
									is_check = false;
									$(".mm_box li").removeClass("mmdd");									
									orderid = '';
									paytype = '';
									$.router.back();
								}else{
									$.myUtil().alert_msg(res.msg);
									$(".mm_box li").removeClass('mmdd');
								}
							})
						})
					},200);
				}
			});
			$("#pay_close").click(function(){
				pwd_index = 0;
				pass = '';
				is_check = false;
				$(".backdrop").hide();
				$("#promise_pay_form").hide();
			})
			$(".nub_ggg li .del").click(function(){
				if(pwd_index>0){
					pwd_index--;
					$(".mm_box li").eq(pwd_index).removeClass("mmdd");
					pass = pass.substr(0,pwd_index);					
					pwd_index==0;
				}
			});
			
			
		},false);
		
		function goliebiao(){
			localStorage.setItem("group_id",0); 
			socket.disconnect();
			clicked('chat-index.html');
		}
		
		function historyBack(){
			console.error('执行historyBack');			
			if(!has_history && !history_back){
				now_date = time2;
				getHistoryMsg(room_id);
				history_back = true;
			}
		}
		
		
		function getHistoryMsg(roomid){
			console.error('读取历史聊天记录' + Date.parse(new Date()));
			
			MobileFrame.getMsg(userinfo.intval_id,roomid,now_date,function(result){
				console.log(result);
				msg_list = [];				
//				if(result.length == 0){
//					has_history = false;
//					historyBack();
//					return;
//				}
				
//				var i = 0;
//				function showMsg(){
//					if(i >= result.length){
//						is_load_history = false;
//						return;
//					}
//					if(result[i] == '') return;
//					msg = JSON.parse(result[i]);
//					memberinfo = getMemberInfo(msg.user);
//	//						console.log(JSON.stringify(memberinfo));
//					if(msg.mtypes){
//						type = $.getMsgType(msg.mtypes);
//						msg.type = type;	
//					}
////					if(typeof msg.content == 'string'){
////						msg.content = JSON.parse(msg.content);	
////					}
//					msg.logo_src = memberinfo.head_portrait;
//					msg.nickname = memberinfo.nickname;
//					
//					msg.user_id = msg.user;
//	//						console.log(msg.content);
//					if(msg.type != 'text'){
//						if(msg.type == 'image'){
//							//filename = msg.content+'m.jpg';
//							//msg.content = "http://www.quweilai.cn/new_api/res/"+self.intval_id+"/"+msg.content+"m.jpg";
//						}else if(msg.type == 'sound'){
//							//filename = msg.content+'.amr';
//						}else if(msg.type == 'video'){
//							//filename = msg.content+'.mp4';
//						}else if(msg.type == 'face'){
//							//msg.content = "images/emoji/"+msg.content+".gif";
//						}else if(msg.type == 'position'){
//							//msg.content = 'http://api.map.baidu.com/staticimage/v2?ak=C8Pn598qtNvbvOFXuLhN8z2j&center='+msg.msg+'&width=512&height=360&zoom=14&markers='+msg.msg+'&dpiType=ph';
//						}else if(msg.type == 'hongbao'){						
//							arr = msg.content.split('@@');
//							id = arr[0];
//							title = arr[1];
//							msg.objid = id;
//							msg.title = title;
//							msg.show_path = msg.content;
//						}else if(msg.type == 'promise'){
//							//msg.content = 'http://api.map.baidu.com/staticimage/v2?ak=C8Pn598qtNvbvOFXuLhN8z2j&center='+msg.msg+'&width=512&height=360&zoom=14&markers='+msg.msg+'&dpiType=ph';					
//							msg.objid = promise_data.id;
//							msg.show_path = msg.content;
//	//								console.log(JSON.stringify(msg));
//						}else if(msg.type == 'share_shop' || msg.type == 'share_user' || msg.type == 'share_info' || msg.type == 'share_hongbao' || msg.type == 'share_card'){
//							share_url = '';
//							msg.share_data = JSON.parse(msg.content);
//							if(msg.type == 'share_shop'){
//								share_url = 'index-shop-index.html?id='+msg.share_data.id;
//							}else if(msg.type == 'share_user'){
//								share_url = 'index-user-index.html?id='+msg.share_data.id;
//							}else if(msg.type == 'share_info'){
//								if(msg.share_data.type == 1 || msg.share_data.type == 2 || msg.share_data.type == 4){
//									share_url = 'index-articel-detail.html?id='+msg.share_data.id;	
//								}else if(msg.share_data.type == 3){
//									share_url = 'index-product-detail.html?id='+msg.share_data.id;
//								}								
//							}else if(msg.type == 'share_card'){
//								share_url = 'index-card.html?id='+msg.share_data.id;
//							}
//							msg.share_data.share_url = share_url;
//							msg.share_data.share_type = msg.type;
//							msg.type = 'share';
//						}else if(msg.type == 'notice'){
//							//msg.content = 
//						}
//					}
//					record.push(msg);
//					msg_list.push(msg);
//					bindMsgList();
//					loopId = setTimeout(showMsg, 300);
//					i++;
//				}
//				loopId = setTimeout(showMsg, 300);
				
				
				
				for(i in result){					
					if(result[i] == '')continue;
					msg = JSON.parse(result[i]);
					memberinfo = getMemberInfo(msg.user);
	//						console.log(JSON.stringify(memberinfo));
					if(msg.mtypes){
						type = $.getMsgType(msg.mtypes);
						msg.type = type;	
					}
//					if(typeof msg.content == 'string'){
//						msg.content = JSON.parse(msg.content);	
//					}
					msg.logo_src = memberinfo.head_portrait;
					msg.nickname = memberinfo.nickname;
					
					msg.user_id = msg.user;
	//						console.log(msg.content);
					if(msg.type != 'text'){
						if(msg.type == 'image'){
							//filename = msg.content+'m.jpg';
							//msg.content = "http://www.quweilai.cn/new_api/res/"+self.intval_id+"/"+msg.content+"m.jpg";
						}else if(msg.type == 'sound'){
							//filename = msg.content+'.amr';
						}else if(msg.type == 'video'){
							//filename = msg.content+'.mp4';
						}else if(msg.type == 'face'){
							//msg.content = "images/emoji/"+msg.content+".gif";
						}else if(msg.type == 'position'){
							//msg.content = 'http://api.map.baidu.com/staticimage/v2?ak=C8Pn598qtNvbvOFXuLhN8z2j&center='+msg.msg+'&width=512&height=360&zoom=14&markers='+msg.msg+'&dpiType=ph';
						}else if(msg.type == 'hongbao'){						
							arr = msg.content.split('@@');
							id = arr[0];
							title = arr[1];
							msg.objid = id;
							msg.title = title;
							msg.show_path = msg.content;
						}else if(msg.type == 'promise'){
							//msg.content = 'http://api.map.baidu.com/staticimage/v2?ak=C8Pn598qtNvbvOFXuLhN8z2j&center='+msg.msg+'&width=512&height=360&zoom=14&markers='+msg.msg+'&dpiType=ph';					
							msg.objid = promise_data.id;
							msg.show_path = msg.content;
	//								console.log(JSON.stringify(msg));
						}else if(msg.type == 'share_shop' || msg.type == 'share_user' || msg.type == 'share_info' || msg.type == 'share_hongbao' || msg.type == 'share_card'){
							share_url = '';
							msg.share_data = JSON.parse(msg.content);
							if(msg.type == 'share_shop'){
								share_url = 'index-shop-index.html?id='+msg.share_data.id;
							}else if(msg.type == 'share_user'){
								share_url = 'index-user-index.html?id='+msg.share_data.id;
							}else if(msg.type == 'share_info'){
								if(msg.share_data.type == 1 || msg.share_data.type == 2 || msg.share_data.type == 4){
									share_url = 'index-articel-detail.html?id='+msg.share_data.id;	
								}else if(msg.share_data.type == 3){
									share_url = 'index-product-detail.html?id='+msg.share_data.id;
								}								
							}else if(msg.type == 'share_card'){
								share_url = 'index-card.html?id='+msg.share_data.id;
							}
							msg.share_data.share_url = share_url;
							msg.share_data.share_type = msg.type;
							msg.type = 'share';
						}else if(msg.type == 'notice'){
							//msg.content = 
						}
					}
					record.push(msg);
					msg_list.push(msg);
					bindMsgList();
					
				}
				is_load_history = false;
				
			})
		}
		
		function getMemberInfo(id){			
			for(i in room_members){				
				if(i == id){
					return room_members[i].info;
				}
			}
		}
		
		
		
		var ui = {
			body:document.querySelector('body'),
			boxMsgText: document.querySelector('#msg-text'),
			boxMsgSound: document.querySelector('#msg-sound'),
			btnMsgImage: document.querySelector('#msg-image'),
			areaMsgList: document.querySelector('#msg-list'),
			boxSoundAlert: document.querySelector('#sound-alert'),
		}
		
		var bindMsgList = function() {
			
			if(record.length == 0) return;			
			var html = template('msg-template', {'record':[record[record.length-1]]});			
//			$("#msg-list").append(html);
			if(is_load_history){
				jQuery("#msg-list").before(html);
			}else{
				jQuery("#msg-list").append(html);	
			}
			
			
			
    		if(myScroll == ''){
    			myScroll = new iScroll('msg-scroll',{
    				hideScrollbar:true,
					fadeScrollbar:true,
					onScrollMove: function () {						
			            if (this.y > 0 && Math.abs(this.y) < 50 ) {  
			            	is_load = true;
			            }
			        },
			        onScrollEnd: function () {
			            if(is_load){
			            	//获取前一天的聊天记录
			            	if(!no_history){
			            		now_date = new Date(Date.parse(new Date(now_date))-(24*60*60*1000)).format("y-m-d");
			            		is_load_history = true;
			            	}
			            	getHistoryMsg(room_id);
			            	is_load = false;
			            }
			        }
    			});
    		}else{
    			setTimeout(function(){
    				myScroll.refresh();    				
    				if($("#msg-list").height() > $("#msg-scroll").height()){
    					myScroll.scrollTo(0,myScroll.maxScrollY);
    				}    				
    			},400);
    		}
			
			
			
			var msgItems = ui.areaMsgList.querySelectorAll('.msg-item');
			[].forEach.call(msgItems, function(item, index) {
				$(item).find('.msg-content').unbind('click').click(function(){
					msgItemTap(item, event);
				});															
			});
			ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;				
		};
		
		var msgItemTap = function(msgItem, event) {
			var msgType = msgItem.getAttribute('msg-type');
			var msgContent = msgItem.getAttribute('msg-content');
			var msgShowPath = msgItem.getAttribute('msg-show_path');
			var face = $(msgItem).find('.msg-user').attr('src');
			console.log(msgContent);
			if (msgType == 'sound') {					
				player = plus.audio.createPlayer(msgShowPath);
				var playState = msgItem.querySelector('.play-state');
				playState.innerText = '正在播放...';
				player.play(function() {
					playState.innerText = '点击播放';
				}, function(e) {
					playState.innerText = '点击播放';
				});
			}else if(msgType == 'video'){
				
				var name = msgContent;
				var suffix = name.substr(name.lastIndexOf('.'));
				var url = '';
				if(suffix=='.mov' || suffix=='.3gp' || suffix=='.mp4' || suffix=='.avi'){						
					url = 'camera_video.html';
				}
				
				plus.runtime.openFile(msgShowPath);
				
				w=plus.webview.create(url,url,{hardwareAccelerated:true,scrollIndicator:'none',scalable:true,bounce:'all'});
				w.addEventListener('loaded', function(){
					w.evalJS('loadMedia("'+msgContent+'")');
					//w.evalJS('loadMedia("'+'http://localhost:13131/_doc/camera/'+name+'")');
				}, false );
				w.addEventListener('close', function(){
					w = null;
				}, false);
				w.show('pop-in');
			}else if(msgType == 'hongbao'){
				var arr = msgContent.split('@@');				
				objid = msgItem.getAttribute('msg-objid');
				console.log(objid);
				$.myUtil().ajax({
					data:{
						'api_name':'luckymoney_openit',
						'token':token,
						'luckyid':objid
					}
				}).done(function(res){
					if(res.state == 'ok'){
						$.myUtil().ajax({
							data:{
								'api_name':'luckymoney_receive',
								'token':token,
								'luckypass':''
							}
						}).done(function(res){
							layer.closeAll();
							console.log(JSON.stringify(res));
							$("#hb_user_pic").attr('src',res.data.userpic);
							$("#hb_nickname").html(res.data.nickname);
							$("#hb_money").html(res.data.money);								
							$("#hongbao_log").html(template('hongbao_logT',res.data))
							$("#hongbao_log").show();
							$("#get_hongbao").show();
							$.router.load("#zd-chat-chai");
							if(res.state != 'ok'){
								$.myUtil().alert_msg(res.msg);return;	
							}
						})
					}else{
						layer.closeAll();
						$.myUtil().alert_msg(res.msg);
						return;
					}
				})
			}else if(msg.type == 'share'){				
				console.log(msgContent);
				sd = JSON.parse(msgContent);
				if(sd.share_type == 'share_card'){
					clicked(sd.share_url);	
				}				
			}
		};
		
		function close_foot(){
			hongbao_is_open = true;
			if(!$("footer").hasClass('chat-slideUp') && $("footer").classList == undefined){
	    		$("footer").attr('class','chat-slideUp');
	    	}else if($("footer").hasClass('chat-slideUp')){
	    		$("footer").attr('class','chat-slideDown');
	    	}
		}
	</script>
	
</body>
</html>