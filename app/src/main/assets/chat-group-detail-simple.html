<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>聊天详情</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="css/font_tbfy9ndgkdwjyvi.css">
	<link rel="stylesheet" href="css/sm.css">
	<link rel="stylesheet" href="css/sm-extend.css">
	<link rel="stylesheet" href="css/login.css">
	<script type='text/javascript' src='js/zepto.js' charset='utf-8'></script>
    <script type="text/javascript" src="js/update.js" ></script>
    <script type="text/javascript" src="js/jquery.1.11.js" ></script>
	<script>$.noConflict();</script>
	<script type="text/javascript" src="js/jquery.qrcode.js" ></script>
	<script type="text/javascript" src="js/cache.js" ></script>
</head>
<body>
	
    <div class="page-group" style="background-color:#f5f5f5;" id="chat-index">
        <div class="page page-current page-from-right-to-center" style="background-color:#f5f5f5;">
        	<header class="bar bar-nav">
        		<button class="button pull-left btn-back" onclick="back()"><img src="images/icon/icon-arrow-left.png" class="icon-close" /></button>				
        		<h1 class="title">聊天详情</h1>
			</header>
        	<div class="content chat-content" style="bottom:0;">
			  	
			  	<div class="content-block add-content-content " id="chat-detail.html" style="padding:0;">
		        	<div class="list-block" style="">
		        		<div class="piclist" id="memberList" style="padding-bottom:0;">
		        			<!--<span>		        				
		        				<div class="face" style="background-image:url(images/chat1.png);background-size:contain;"></div>
		        				<p class="substr">发到空间</p>
		        			</span>
		        			<span id="add-add">
		        				<img src="images/chat-group-add.png" />
		        				<p class="substr">&nbsp;</p>
		        			</span>
		        			<span id="sub-user">
		        				<img src="images/chat-group-.png" />
		        				<p class="substr">&nbsp;</p>
		        			</span>-->
		        		</div>
		        		
		        	</div>
		        	
		        	
		        	<div class="list-block" style="margin-bottom:1.33333333rem;">
		        		<ul>
					        <li class="item-content" style="padding:0 1.333333rem;">						          	
					          	<div class="item-inner uc-list-inner my-inner-list" style="height:inherit;margin-left:0;padding:0.666666rem 0;">
					            	<div class="item-title"><p style="line-height:2rem;">消息免打扰</p></div>	
					            	<div class="item-after">
					            		<div class="item-input">
							            	<label class="label-switch">
								                <input type="checkbox" id="notice">
								                <div class="checkbox" id="setnotice"></div>
							            	</label>
							            </div>
					            	</div>
					          	</div>
					        </li>
					        <li class="item-content" style="padding:0 1.333333rem;" id="chat-top">						          	
					          	<div class="item-inner uc-list-inner my-inner-list"  style="height:inherit;margin-left:0;padding:0.666666rem 0;">
					            	<div class="item-title"><p style="line-height:2rem;">置顶聊天</p></div>
					            	<div class="item-after">
					            		<div class="item-input">
							            	<label class="label-switch">
								                <input type="checkbox" id="top">
								                <div class="checkbox"></div>
							            	</label>
							            </div>
					            	</div>
					          	</div>
					        </li>
					    </ul>
		        	</div>
		        	
		        	<div class="list-block" style="margin-bottom:1.33333333rem;">
		        		<ul>					        
					        <li class="item-content" style="padding:0 1.333333rem;" id="clear-log">						          	
					          	<div class="item-inner uc-list-inner my-inner-list"  style="height:inherit;margin-left:0;padding:0.666666rem 0;">
					            	<div class="item-title"><p style="line-height:2rem;">清除聊天记录</p></div>
					            	<div class="item-after"></div>
					          	</div>
					        </li>
					    </ul>
		        	</div>
		        	<div class="list-block" id="tousu">
		        		<ul>
					        <li class="item-content" style="padding:0 1.333333rem;">						          	
					          	<div class="item-inner uc-list-inner my-inner-list" style="margin-left:0;padding:0.666666rem 0;height:4rem;">
					            	<div class="item-title"><p style="line-height:2rem;">投诉</p></div>
					          	</div>
					        </li>
					    </ul>
		        	</div>
		        	
		        	<div class="list-block" id="quit" style="display:none;">
		        		<button class="btn-big " id="btn-edit" style="background-color:#00C853;">退出聊天</button>
		        	</div>
		       </div>
			</div>
        </div>
    </div>
   
   <script type="text/html" id="memberListT">    	
		{{each list as item i}}
		<span onclick="clicked('userinfo.html?id={{item.info.user_id}}')">			
			<div class="face" style="background-image:url({{item.info.head_portrait}});background-size:cover;"></div>
			<p class="substr" style="text-align:center;">{{if item.info.nickname}}{{item.info.nickname}}{{else}}未设置{{/if}}</p>
		</span>
		{{/each}}
		<!--<span id="add-add">
			<img src="images/chat-group-add.png"/>
			<p class="substr">&nbsp;</p>
		</span>
		<span id="sub-user">
			<img src="images/chat-group-.png"/>
			<p class="substr">&nbsp;</p>
		</span>	        -->
    </script>
    
	<script type='text/javascript' src='js/sm.js' charset='utf-8'></script>
	<script type='text/javascript' src='js/sm-extend.js' charset='utf-8'></script>
	<script type='text/javascript' src='js/template.js' charset='utf-8'></script>
	<script type="text/javascript" src="js/layer/layer.js" ></script>
	<script>
		var qr_show = 0;
		var room_id = '';
		$(function(){
			var token = localStorage.getItem('token');
			if(token == '' || token == null || token == undefined){
//				$.myUtil().alert_msg('身份已过期，请重新登录',function(){localStorage.clear();location.href='login.html';});
			}
			userinfo = JSON.parse(localStorage.getItem('userinfo'));
			param = $.myUtil().toQueryParams();
			room_id = param['room_id'];
			
			if(room_id.substr(0,2) == 'd1'){
				$("#quit").show();
			}
			
			var isNotice = localStorage.getItem(room_id);
			console.log(isNotice);
			if(isNotice != undefined){
				if(isNotice == 1){
					$("#notice").attr('checked','checked');					
				}else if(isNotice == 0){
					$("#notice").removeAttr('checked');
				}
			}
			
			memberList = JSON.parse(localStorage.getItem(room_id));
			$.myUtil().ajax({
				data:{
					'api_name':'chatgroup_qunlists',
					'token':token,
					'room_id':room_id
				}
			}).done(function(res){
				layer.closeAll();
				if(res.state == 'ok'){
					console.log(JSON.stringify(res));
					localStorage.setItem(room_id,JSON.stringify(res.data.room_members));
					$("#memberList").html(template('memberListT',{list:res.data.room_members}));
					$("#gname").val(res.data.room_name);
					if(res.data.room_admin == userinfo.intval_id){
						$("#gname").removeAttr('readonly');
					}
					$("#add-add").click(function(){
						clicked('chat-group-friend-add.html?id='+room_id);
					})
					$("#sub-user").click(function(){
						clicked('chat-group-del-member.html?id='+room_id);
					})
					
				}else{
					$.myUtil().alert_msg(res.msg);
				}
			});
			
			$("#btn-edit").click(function(){
				$(".drop_menu").hide();
				$.myUtil().ajax({
					data:{
						'api_name':'kict_xunjialeave',
						'token':token,
						'room_id':room_id
					},beforeFn:function(){}
				}).done(function(res){
					$.myUtil().toast(res.msg,2,function(){
						if(res.state == 'ok'){
							back();
						}
					});
				})
			})
			
			$("#gname").on('blur',function(){
				val = $(this).val();
				if(val == ''){
					$.myUtil().toast('群名称不能为空');return;
				}
				$.myUtil().ajax({
					data:{
						'api_name':'chatgroup_changename',
						'token':token,
						'room_name':val,
						'room_id':room_id
					},beforeFn:function(){}
				}).done(function(res){
					$.myUtil().toast(res.msg);
				})
			})
			
			$("#gname").on('blur',function(){
				val = $(this).val();
				if(val == ''){
					$.myUtil().toast('群昵称不能为空');return;
				}
//				$.myUtil().ajax({
//					data:{
//						'api_name':'chatgroup_changename',
//						'token':token,
//						'room_name':val,
//						'room_id':room_id
//					},beforeFn:function(){}
//				}).done(function(res){
//					$.myUtil().toast(res.msg);
//				})
			})
			
			$("#tousu").click(function(){
				clicked('index-tousu.html?id='+room_id+"&type=4");
			});
			
			$("#setnotice").click(function(){
				$.myUtil().ajax({
					data:{
						'api_name':'tixing_qunpbgr',
						'token':token,
						'room_id':room_id
					},beforeFn:function(){}
				}).done(function(res){
					if(res.state == 'ok'){
						if(res.data.status == 1){
							localStorage.setItem(room_id,1);
							console.log(localStorage.getItem(room_id));
							$("#notice").attr('checked');
						}else{
							localStorage.setItem(room_id,0);
							$("#notice").removeAttr('checked');
						}
					}
				})
			})
			
			$("#erweima").click(function(){
				$.myUtil().ajax({
					data:{
						'api_name':'chatgroup_build',
						'token':token,
						'room_id':room_id
					}
				}).done(function(res){
					layer.closeAll();
					if(res.state == 'ok'){
						html = ''+
							'<div class="inner-block  inner-bottom-line">'+
								'<div class="inner-line table">'+
									'<span class="iconfont icon-jiahao-copy-copy table-cell" style="width:2rem;" onclick="layer.closeAll();"></span><span class="table-cell" style="width:24rem;text-align:center;">扫码加入群</span>'+
								'</div>'+			
							'</div>'+
							'<div class="eqcode" id="qrcode" style="width:16rem;height:16rem;margin:0 auto;margin-top:10rem;border:0"></div>';
						layer.open({
							type: 1
							,content: html
							,anim: 'left'
							,style: 'position:fixed; left:0; top:0; background-color:#fff;width:100%; height:100%; border: none; -webkit-animation-duration: .5s; animation-duration: .5s;'					
						});
						font_size = parseFloat($("html").css('font-size'));
						_width = 16 * font_size;
						jQuery("#qrcode").qrcode({"width":_width,"height":_width,"text":res.data.qrcode});						
						qr_show = 1;
					}else{
						$.myUtil().alert_msg(res.msg);
					}
				});
				
			})
			
		});				
		
		(function(w){
			// 空函数
			function shield(){
				return false;
			}
			document.addEventListener('touchstart',shield,false);//取消浏览器的所有事件，使得active的样式在手机上正常生效
			document.oncontextmenu=shield;//屏蔽选择函数
			// H5 plus事件处理
			var ws=null,as='pop-out';
			function plusReady(){
				
				ws=plus.webview.currentWebview();
				// Android处理返回键
				plus.key.addEventListener('backbutton',function(){
					console.log("@@@@@@@@@@@@22");
					now_ww = plus.webview.currentWebview();
					console.log(qr_show);
					if(qr_show == 1){
						layer.closeAll();
						qr_show = 0;
						return;
					}else{						
						if(now_ww.id == 'ucenter.html' || now_ww.id == 'index.html' || now_ww.id == 'index-all.html' || now_ww.id == 'zd-index.html'){
							('iOS'==plus.os.name)?plus.nativeUI.confirm('确认退出？', function(e){
								if(e.index>0){
									plus.runtime.quit();
								}
							}, '诚信', ['取消','确定']):(confirm('确认退出？')&&plus.runtime.quit());
						}else if(now_ww.id == 'uc-address-add.html' || now_ww.id == 'uc-address-edit.html'){
							console.log(now_ww.id);
							clicked('uc-address.html');
						}else{
							back();	
						}
					}							
				},false);
				compatibleAdjust();
			}
			if(w.plus){
				plusReady();
			}else{
				document.addEventListener('plusready',plusReady,false);
			}
			// DOMContentLoaded事件处理
			var domready=false;
			document.addEventListener('DOMContentLoaded',function(){
				domready=true;
				gInit();
				document.body.onselectstart=shield;
				compatibleAdjust();
			},false);
			
			w.qrcode_config = {};
			
			// 处理返回事件
			w.back=function(hide){
			//	taskList = plus.webview.getWebviewById("uc-usetting.html");
			//	taskList.reload();
			    
				if(w.plus){
					ws||(ws=plus.webview.currentWebview());
					if(hide||ws.preate){	
						ws.hide('auto');
					}else{
						
						if(ws.id == 'newdrag'){
							nw = plus.webview.getWebviewById('index-map.html');			
							nw.close('auto');
						}
						ws.close('auto');
					}
				}else if(history.length>1){
					history.back();
				}else{
					w.close();
				}
			};
			// 处理点击事件
			var openw=null,waiting=null;
			/**
			 * 打开新窗口
			 * @param {URIString} id : 要打开页面url
			 * @param {boolean} wa : 是否显示等待框
			 * @param {boolean} ns : 是否不自动显示
			 * @param {JSON} ws : Webview窗口属性
			 */
			w.clicked=function(id,wa,ns,ws,myas){
				openw = plus.webview.getWebviewById(id);
				if(openw){//避免多次打开同一个页面
					//.return null;
					if(id == 'index.html'){
						if(plus.webview.getWebviewById('index2.html') != null){
							plus.webview.getWebviewById('index2.html').close();	
						}			
					}
					if(id == 'index-map.html'){
						if(plus.webview.getWebviewById('index-list.html') != null){
							plus.webview.getWebviewById('index-list.html').close();	
						}			
					}
					
					openw.close();
				}
				//plus.webview.close('newdrag');
				if(w.plus){
					wa&&(waiting=plus.nativeUI.showWaiting());
					ws=ws||{};
					ws.scrollIndicator||(ws.scrollIndicator='none');
					ws.scalable||(ws.scalable=false);
					var pre='';//'http://192.168.1.178:8080/h5/';
					openw=plus.webview.create(pre+id,id,ws);		
			//		ns||openw.addEventListener('loaded',function(){//页面加载完成后才显示
			//		setTimeout(function(){//延后显示可避免低端机上动画时白屏		
						if(myas != ''){
							openw.show(myas);
						}else{
							openw.show(as);	
						}			
						closeWaiting();
			//		},100);
			//		},false);
					openw.addEventListener('close',function(){//页面关闭后可再次打开
						openw=null;
					},false);
					return openw;
				}else{
					w.open(id);
				}
				return null;
			};
			w.openDoc=function(t,c){
				var d=plus.webview.getWebviewById('document');
				if(d){
					d.evalJS('updateDoc("'+t+'","'+c+'")');
				}else{
					d=plus.webview.create('/plus/doc.html','document',{zindex:9999,popGesture:'hide'},{preate:true});
					d.addEventListener('loaded',function(){
						d.evalJS('updateDoc("'+t+'","'+c+'")');
					},false);
				}
			}
			/**
			 * 关闭等待框
			 */
			w.closeWaiting=function(){
				waiting&&waiting.close();
				waiting=null;
			}
			// 兼容性样式调整
			var adjust=false;
			function compatibleAdjust(){
				if(adjust||!w.plus||!domready){
					return;
				}	// iOS平台使用滚动的div
				if('iOS'==plus.os.name){
					var t=document.getElementById("dcontent");
					t&&(t.className="sdcontent");
					t=document.getElementById("content");
					t&&(t.className="scontent");
					//iOS8横竖屏切换div不更新滚动问题
					var lasto=window.orientation;
					window.addEventListener("orientationchange",function(){
						var nowo=window.orientation;
						if(lasto!=nowo&&(90==nowo||-90==nowo)){
							window.dcontent&&(0==dcontent.scrollTop)&&(dcontent.scrollTop=1);
							window.content&&(0==content.scrollTop)&&(content.scrollTop=1);
						}
						lasto=nowo;
					},false);
				}
				adjust=true;
			};
			w.compatibleConfirm=function(){
				plus.nativeUI.confirm('本OS原生层面不提供该控件，需使用mui框架实现类似效果。请点击“确定”下载Hello mui示例',function(e){
					if(0==e.index){
						plus.runtime.openURL("http://www.dcloud.io/hellomui/");
					}
				},"",["确定","取消"]);
			}
			// 通用元素对象
			var _dout_=null,_dcontent_=null;
			w.gInit=function(){
				_dout_=document.getElementById("output");
				_dcontent_=document.getElementById("dcontent");
			};
			// 清空输出内容
			w.outClean=function(){
				_dout_.innerText="";
				_dout_.scrollTop=0;//在iOS8存在不滚动的现象
			};
			// 输出内容
			w.outSet=function(s){
				_dout_.innerText=s+"\n";
				(0==_dout_.scrollTop)&&(_dout_.scrollTop=1);//在iOS8存在不滚动的现象
			};
			// 输出行内容
			w.outLine=function(s){
				_dout_.innerText+=s+"\n";
				(0==_dout_.scrollTop)&&(_dout_.scrollTop=1);//在iOS8存在不滚动的现象
			};
			// 格式化时长字符串，格式为"HH:MM:SS"
			w.timeToStr=function(ts){
				if(isNaN(ts)){
					return "--:--:--";
				}
				var h=parseInt(ts/3600);
				var m=parseInt((ts%3600)/60);
				var s=parseInt(ts%60);
				return (ultZeroize(h)+":"+ultZeroize(m)+":"+ultZeroize(s));
			};
			// 格式化日期时间字符串，格式为"YYYY-MM-DD HH:MM:SS"
			w.dateToStr=function(d){
				return (d.getFullYear()+"-"+ultZeroize(d.getMonth()+1)+"-"+ultZeroize(d.getDate())+" "+ultZeroize(d.getHours())+":"+ultZeroize(d.getMinutes())+":"+ultZeroize(d.getSeconds()));
			};
			/**
			 * zeroize value with length(default is 2).
			 * @param {Object} v
			 * @param {Number} l
			 * @return {String} 
			 */
			w.ultZeroize=function(v,l){
				var z="";
				l=l||2;
				v=String(v);
				for(var i=0;i<l-v.length;i++){
					z+="0";
				}
				return z+v;
			};
		})(window);
		
		document.addEventListener('plusready',function(){
			$("#clear-log").click(function(){
				$.myUtil().dialog('清除聊天记录','确定清除聊天记录吗?',function(){					
					$.myUtil().dialog_close();					
					MobileFrame.clearCache(room_id,function(rs,msg){
						alert('清除成功');
						
					});
				},function(){
					$.myUtil().dialog_close();
				});
				
			});
		},false)
		
	</script>
</body>
</html>